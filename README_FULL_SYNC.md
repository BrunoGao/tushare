# 股票全量数据异步同步系统

## 📋 功能特点

### 🚀 异步高效
- **多线程并发**: 支持最多10个线程同时获取数据
- **批量处理**: 每批处理30只股票，提高效率
- **频率控制**: 自动遵守tushare API频率限制（500次/分钟）
- **智能重试**: 失败任务自动记录，支持重新运行

### 💾 断点续传
- **进度保存**: 实时保存获取进度到 `logs/fetch_progress.json`
- **断点续传**: 程序中断后可从上次位置继续
- **状态跟踪**: 详细记录成功/失败股票列表

### 📊 实时监控
- **进度可视化**: 实时显示进度条和完成百分比
- **统计信息**: 显示获取速度、剩余时间等
- **表格管理**: 自动按月创建分表，优化查询性能

## 🛠️ 使用方法

### 1. 快速启动
```bash
# 使用交互式启动脚本
./start_full_sync.sh

# 或直接运行
python3 fetch_full_data_async.py
```

### 2. 监控进度
```bash
# 实时监控进度（推荐在新终端窗口运行）
python3 monitor_progress.py --monitor

# 查看当前进度快照
python3 monitor_progress.py

# 查看最终汇总报告
python3 monitor_progress.py --summary
```

### 3. 配置参数
编辑 `fetch_full_data_async.py` 中的参数：
```python
fetcher = AsyncStockDataFetcher(
    max_workers=8,   # 并发线程数（建议4-10）
    batch_size=30    # 每批股票数（建议20-50）
)
```

## 📊 数据范围

- **股票范围**: 所有已上市A股（约5150只）
- **时间范围**: 最近3年历史数据
- **数据类型**: 日线行情数据（开高低收、成交量等）
- **存储方式**: 按月分表存储，提高查询效率

## 📈 性能预期

### 理论性能
- **API限制**: 500次请求/分钟
- **预估时间**: 约10-15分钟完成全部股票
- **数据量**: 预计300-500万条记录
- **存储空间**: 约1-2GB数据

### 实际表现
```
📊 并发线程: 8个
📋 批处理: 30只股票/批
⏱️ 平均速度: 5-8只股票/分钟
💾 数据量: 每只股票约600-800条记录
```

## 🗂️ 数据库结构

### 分表策略
```sql
-- 按月分表，例如：
stock_daily_202401  -- 2024年01月
stock_daily_202402  -- 2024年02月
stock_daily_202403  -- 2024年03月
...
```

### 表结构
```sql
CREATE TABLE stock_daily_YYYYMM (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    ts_code VARCHAR(20) NOT NULL,        -- 股票代码
    trade_date DATE NOT NULL,            -- 交易日期
    open DECIMAL(10,3),                  -- 开盘价
    high DECIMAL(10,3),                  -- 最高价
    low DECIMAL(10,3),                   -- 最低价
    close DECIMAL(10,3),                 -- 收盘价
    pre_close DECIMAL(10,3),             -- 昨收价
    `change` DECIMAL(10,3),              -- 涨跌额
    pct_chg DECIMAL(8,4),                -- 涨跌幅
    vol BIGINT,                          -- 成交量(手)
    amount DECIMAL(20,3),                -- 成交额(千元)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_code_date (ts_code, trade_date),
    INDEX idx_code (ts_code),
    INDEX idx_date (trade_date)
);
```

## 📋 监控界面示例

```
======================================================================
📊 股票数据获取进度监控
======================================================================
进度: [████████████████████████████████░░░░░░░░░░░░░░░░░░] 64.2%

📈 股票处理统计:
  总股票数(估算): 5,150
  已完成股票:     3,306
  成功获取:       3,280
  获取失败:       26

📊 数据统计:
  总记录数:       2,456,789
  已创建表数:     36
  平均每股记录:   749

⏱️  时间统计:
  运行时长:       8.5分钟
  预估剩余:       4.2分钟
  平均每股耗时:   0.15秒

🕒 最后更新: 2025-08-04 17:15:32
======================================================================
💡 按 Ctrl+C 退出监控
```

## 🔧 故障排除

### 常见问题

1. **API频率限制**
   ```
   ⏱️ 达到频率限制，等待 XX 秒...
   ```
   - 这是正常现象，程序会自动等待

2. **数据库连接失败**
   - 检查 `config.py` 中的数据库配置
   - 确保MySQL服务正在运行

3. **tushare Token无效**
   - 检查 `config.py` 中的 `TS_TOKEN` 配置
   - 确保token有效且有足够积分

4. **内存占用过高**
   - 降低 `max_workers` 参数
   - 减少 `batch_size` 参数

### 日志文件
- `logs/fetch_full_data.log`: 详细运行日志
- `logs/fetch_progress.json`: 进度状态文件

## 🚨 注意事项

1. **网络稳定性**: 确保网络连接稳定，避免频繁中断
2. **磁盘空间**: 预留至少3GB磁盘空间
3. **系统资源**: 建议4GB以上内存，避免高峰期运行
4. **数据备份**: 定期备份重要数据
5. **API积分**: 确保tushare账户有足够积分

## 🎯 后续优化

- [ ] 支持增量更新模式
- [ ] 添加数据质量检查
- [ ] 支持更多数据类型（分钟线、财务数据等）
- [ ] 添加Web监控界面
- [ ] 支持集群部署

---

🎉 **开始使用**: 运行 `./start_full_sync.sh` 开始您的数据之旅！