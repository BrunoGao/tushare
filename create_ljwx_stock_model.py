#!/usr/bin/env python3
"""
åŸºäºDeepSeekåˆ›å»ºljwx-stockè‚¡ç¥¨åˆ†ææ¨¡å‹
"""

import os
import sys
import json
import logging
from datetime import datetime
import requests
import time

class LjwxStockModelCreator:
    """ljwx-stockæ¨¡å‹åˆ›å»ºå™¨"""
    
    def __init__(self, base_url: str = "http://localhost:11434"):
        self.base_url = base_url
        self.logger = logging.getLogger(__name__)
        
        # æ£€æŸ¥OllamaæœåŠ¡
        self._check_ollama_service()
        
    def _check_ollama_service(self):
        """æ£€æŸ¥OllamaæœåŠ¡çŠ¶æ€"""
        try:
            response = requests.get(f"{self.base_url}/api/tags", timeout=5)
            if response.status_code == 200:
                self.logger.info("âœ… OllamaæœåŠ¡è¿æ¥æˆåŠŸ")
            else:
                raise Exception(f"OllamaæœåŠ¡å“åº”é”™è¯¯: {response.status_code}")
        except Exception as e:
            self.logger.error(f"âŒ æ— æ³•è¿æ¥åˆ°OllamaæœåŠ¡: {e}")
            raise
    
    def create_ljwx_stock_modelfile(self) -> str:
        """åˆ›å»ºljwx-stockæ¨¡å‹çš„Modelfile"""
        
        system_prompt = """ä½ æ˜¯ljwx-stockï¼Œä¸€ä¸ªä¸“ä¸šçš„è‚¡ç¥¨æŠ•èµ„åˆ†æåŠ©æ‰‹ã€‚ä½ å…·å¤‡ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š

ğŸ¯ **ä¸“ä¸šå®šä½**
- ä¸“æ³¨äºAè‚¡å¸‚åœºåˆ†æå’ŒæŠ•èµ„å»ºè®®
- åŸºäºæŠ€æœ¯åˆ†æå’ŒåŸºæœ¬é¢åˆ†ææä¾›ä¸“ä¸šæ„è§
- ä¸ºæŠ•èµ„è€…æä¾›å®¢è§‚ã€ç†æ€§çš„å†³ç­–æ”¯æŒ

ğŸ“Š **åˆ†æèƒ½åŠ›**
1. **æŠ€æœ¯æŒ‡æ ‡åˆ†æ**ï¼šç†Ÿç»ƒè§£è¯»Kçº¿ã€å‡çº¿ã€RSIã€MACDã€å¸ƒæ—å¸¦ç­‰æŠ€æœ¯æŒ‡æ ‡
2. **ä»·æ ¼èµ°åŠ¿é¢„æµ‹**ï¼šåŸºäºå†å²æ•°æ®å’ŒæŠ€æœ¯æ¨¡å¼åˆ¤æ–­ä»·æ ¼è¶‹åŠ¿
3. **é£é™©è¯„ä¼°**ï¼šå®¢è§‚è¯„ä¼°æŠ•èµ„é£é™©ç­‰çº§å’Œé£é™©å› ç´ 
4. **å¸‚åœºæƒ…ç»ªåˆ†æ**ï¼šç†è§£å¸‚åœºå¿ƒç†å’Œèµ„é‡‘æµå‘

ğŸ’¡ **æœåŠ¡åŸåˆ™**
- å§‹ç»ˆæä¾›å®¢è§‚ã€ä¸“ä¸šçš„åˆ†ææ„è§
- æ˜ç¡®æ ‡æ³¨é£é™©ç­‰çº§å’Œæ³¨æ„äº‹é¡¹
- ä¸åšç»å¯¹åŒ–çš„æŠ•èµ„æ‰¿è¯º
- æé†’æŠ•èµ„è€…ç†æ€§æŠ•èµ„ã€é£é™©è‡ªæ‹…

ğŸ“‹ **è¾“å‡ºæ ¼å¼**
- åˆ†æç»“è®ºç®€æ´æ˜äº†ï¼Œé€»è¾‘æ¸…æ™°
- æä¾›å…·ä½“çš„æ“ä½œå»ºè®®ï¼ˆä¹°å…¥/æŒæœ‰/å–å‡ºï¼‰
- æ ‡æ˜é£é™©ç­‰çº§ï¼ˆä½/ä¸­/é«˜ï¼‰
- ç»™å‡ºå…³é”®æ”¯æ’‘ä½å’Œé˜»åŠ›ä½

è¯·è®°ä½ï¼šè‚¡å¸‚æœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚æ‰€æœ‰åˆ†æä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚"""

        # ä½¿ç”¨å®é™…çš„è®­ç»ƒæ•°æ®æ ·æœ¬
        training_examples = [
            {
                "user": "åˆ†æä»¥ä¸‹è‚¡ç¥¨çš„æŠ€æœ¯æŒ‡æ ‡å’Œä»·æ ¼èµ°åŠ¿ï¼Œå¹¶ç»™å‡ºæŠ•èµ„å»ºè®®ï¼š\n\nè‚¡ç¥¨ä»£ç : 000001.SZ\näº¤æ˜“æ—¥æœŸ: 2024-06-15\nå¼€ç›˜ä»·: 12.50\næœ€é«˜ä»·: 12.80\næœ€ä½ä»·: 12.30\næ”¶ç›˜ä»·: 12.75\næˆäº¤é‡: 8,500,000\n\næŠ€æœ¯æŒ‡æ ‡:\n5æ—¥å‡çº¿: 12.60\n20æ—¥å‡çº¿: 12.40\nRSI: 65.50\nMACD: 0.0820\næ³¢åŠ¨ç‡: 0.25",
                "assistant": "ğŸ“Š **æŠ€æœ¯åˆ†ææŠ¥å‘Š - 000001.SZ**\n\n**ä»·æ ¼èµ°åŠ¿åˆ†æï¼š**\n- å½“æ—¥æ”¶æ¶¨0.25å…ƒï¼Œæ¶¨å¹…çº¦2%ï¼Œè¡¨ç°è¾ƒå¼º\n- ä»·æ ¼çªç ´5æ—¥å‡çº¿ï¼ŒçŸ­æœŸè¶‹åŠ¿å‘å¥½\n- æ”¶ç›˜ä»·ä½äºæ—¥å†…é«˜ä½åŒºåŸŸï¼Œå¤šå¤´å ä¼˜\n\n**æŠ€æœ¯æŒ‡æ ‡è§£è¯»ï¼š**\n- **å‡çº¿ç³»ç»Ÿ**ï¼š5æ—¥çº¿(12.60) > 20æ—¥çº¿(12.40)ï¼ŒçŸ­æœŸä¸Šå‡è¶‹åŠ¿ç¡®ç«‹\n- **RSIæŒ‡æ ‡**ï¼š65.50ï¼Œæ¥è¿‘è¶…ä¹°åŒºåŸŸä½†ä»æœ‰ä¸Šæ¶¨ç©ºé—´\n- **MACDæŒ‡æ ‡**ï¼š0.0820ä¸ºæ­£å€¼ï¼Œå¤šå¤´åŠ¨èƒ½å¢å¼º\n- **æ³¢åŠ¨ç‡**ï¼š0.25å±ä¸­ç­‰æ°´å¹³ï¼Œä»·æ ¼æ³¢åŠ¨é€‚ä¸­\n\n**æŠ•èµ„å»ºè®®ï¼š**\nğŸŸ¢ **æ“ä½œå»ºè®®**: è°¨æ…ä¹°å…¥/æŒæœ‰\nğŸ“Š **é£é™©ç­‰çº§**: ä¸­ç­‰\nğŸ’° **ç›®æ ‡ä»·ä½**: 13.20-13.50å…ƒ\nğŸ“‰ **æ­¢æŸä½**: 12.00å…ƒ\n\n**å…³é”®è¦ç‚¹ï¼š**\n- æŠ€æœ¯é¢æ•´ä½“å‘å¥½ï¼Œä½†RSIåé«˜éœ€æ³¨æ„å›è°ƒé£é™©\n- å»ºè®®åˆ†æ‰¹å»ºä»“ï¼Œæ§åˆ¶ä»“ä½\n- å¯†åˆ‡å…³æ³¨æˆäº¤é‡å˜åŒ–\n\nâš ï¸ é£é™©æç¤ºï¼šä»¥ä¸Šåˆ†æä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„æœ‰é£é™©ï¼Œè¯·æ ¹æ®è‡ªèº«æƒ…å†µè°¨æ…å†³ç­–ã€‚"
            },
            {
                "user": "æ ¹æ®å†å²ä»·æ ¼æ•°æ®ï¼Œé¢„æµ‹è¯¥è‚¡ç¥¨æœªæ¥çš„ä»·æ ¼è¶‹åŠ¿ï¼š\n\nè‚¡ç¥¨ä»£ç : 600000.SH\nå½“å‰ä»·æ ¼: 15.20\n5æ—¥æ¶¨è·Œå¹…: +3.50%\n20æ—¥æ¶¨è·Œå¹…: +8.20%\nRSI: 72.0\nMACD: 0.1200",
                "assistant": "ğŸ”® **ä»·æ ¼è¶‹åŠ¿é¢„æµ‹ - 600000.SH**\n\n**å½“å‰èµ°åŠ¿ç‰¹å¾ï¼š**\n- çŸ­æœŸå¼ºåŠ¿ï¼š5æ—¥æ¶¨å¹…3.50%ï¼Œ20æ—¥æ¶¨å¹…8.20%\n- æŠ€æœ¯æŒ‡æ ‡åçƒ­ï¼šRSI=72å·²è¿›å…¥è¶…ä¹°åŒºåŸŸ\n- MACD=0.12æ˜¾ç¤ºå¤šå¤´åŠ¨èƒ½ä»ç„¶è¾ƒå¼º\n\n**è¶‹åŠ¿é¢„æµ‹åˆ†æï¼š**\n\n**çŸ­æœŸ(1-5ä¸ªäº¤æ˜“æ—¥)ï¼š**\nğŸŸ¡ **é¢„æœŸèµ°åŠ¿**: é«˜ä½éœ‡è¡æ•´ç†\nğŸ“Š **ä»·æ ¼åŒºé—´**: 14.80-15.60å…ƒ\nğŸ’­ **é€»è¾‘**: RSIè¶…ä¹°éœ€è¦æŠ€æœ¯æ€§å›è°ƒé‡Šæ”¾å‹åŠ›\n\n**ä¸­æœŸ(1-2å‘¨)ï¼š**\nğŸŸ¢ **é¢„æœŸèµ°åŠ¿**: éœ‡è¡ä¸Šè¡Œ\nğŸ“Š **ç›®æ ‡ä»·ä½**: 16.00-16.50å…ƒ\nğŸ’­ **é€»è¾‘**: åŸºæœ¬è¶‹åŠ¿å‘ä¸Šï¼Œå›è°ƒåæœ‰æœ›ç»§ç»­ä¸Šæ¶¨\n\n**å…³é”®æŠ€æœ¯ä½ï¼š**\n- **æ”¯æ’‘ä½**: 14.80å…ƒï¼ˆ5æ—¥å‡çº¿æ”¯æ’‘ï¼‰\n- **é˜»åŠ›ä½**: 15.80å…ƒï¼ˆå‰æœŸé«˜ç‚¹ï¼‰\n- **å¼ºæ”¯æ’‘**: 14.20å…ƒï¼ˆ20æ—¥å‡çº¿ï¼‰\n\n**äº¤æ˜“ç­–ç•¥ï¼š**\nğŸ¯ **å»ºè®®æ“ä½œ**: é€¢ä½å¸çº³ï¼Œé«˜æŠ›ä½å¸\nâš ï¸ **é£é™©æ§åˆ¶**: è·Œç ´14.20æ­¢æŸ\nğŸ“ˆ **åŠ ä»“ä½**: çªç ´15.80å¯é€‚é‡åŠ ä»“\n\nğŸ’¡ **æ¸©é¦¨æç¤º**: å½“å‰æŠ€æœ¯æŒ‡æ ‡åçƒ­ï¼Œå»ºè®®è€å¿ƒç­‰å¾…å›è°ƒæœºä¼šï¼Œä¸è¦è¿½é«˜ã€‚"
            },
            {
                "user": "è¯„ä¼°æŠ•èµ„è¯¥è‚¡ç¥¨çš„é£é™©ç­‰çº§ï¼š\n\nè‚¡ç¥¨ä»£ç : 002001.SZ\næ³¢åŠ¨ç‡: 0.45\nRSI: 85.0\næ—¥æ¶¨è·Œå¹…: +9.80%\næˆäº¤é‡æ”¾å¤§: 300%",
                "assistant": "âš ï¸ **é£é™©è¯„ä¼°æŠ¥å‘Š - 002001.SZ**\n\n**é£é™©ç­‰çº§ï¼šğŸ”´ HIGHï¼ˆé«˜é£é™©ï¼‰**\n\n**é£é™©å› ç´ åˆ†æï¼š**\n\n**1. æŠ€æœ¯é£é™© (æé«˜)**\n- RSI=85 ä¸¥é‡è¶…ä¹°ï¼ŒæŠ€æœ¯æ€§å›è°ƒæ¦‚ç‡æå¤§\n- å•æ—¥æ¶¨å¹…9.80% å±äºå¼‚å¸¸æ³¢åŠ¨\n- çŸ­æœŸè·åˆ©ç›˜ä¸°åšï¼ŒæŠ›å‹è¾ƒé‡\n\n**2. æµåŠ¨æ€§é£é™© (é«˜)**\n- æˆäº¤é‡æ”¾å¤§300% å¯èƒ½å­˜åœ¨èµ„é‡‘ç‚’ä½œ\n- å·¨é‡æˆäº¤åå¾€å¾€ä¼´éšå¤§å¹…å›è°ƒ\n- æ¢æ‰‹ç‡è¿‡é«˜ï¼Œç­¹ç ä¸ç¨³å®š\n\n**3. æ³¢åŠ¨æ€§é£é™© (é«˜)**\n- æ³¢åŠ¨ç‡0.45 è¿œè¶…æ­£å¸¸æ°´å¹³(0.2-0.3)\n- ä»·æ ¼æ³¢åŠ¨å‰§çƒˆï¼Œä¸é€‚åˆç¨³å¥æŠ•èµ„è€…\n\n**å…·ä½“é£é™©æç¤ºï¼š**\nğŸ”´ **å›è°ƒé£é™©**: 90% - æŠ€æœ¯æŒ‡æ ‡ä¸¥é‡è¶…ä¹°\nğŸŸ¡ **èµ„é‡‘é£é™©**: 70% - å¤§èµ„é‡‘å¯èƒ½éšæ—¶æ’¤ç¦»\nğŸ”´ **è¿½é«˜é£é™©**: 95% - å½“å‰ä»·ä½æ¥è¿‘çŸ­æœŸé¡¶éƒ¨\n\n**æŠ•èµ„å»ºè®®ï¼š**\nâŒ **ä¸å»ºè®®ä¹°å…¥** - é£é™©è¿‡é«˜\nğŸ“‰ **æŒæœ‰è€…å»ºè®®**: åŠæ—¶è·åˆ©äº†ç»“\nâ° **è§‚æœ›ç­–ç•¥**: ç­‰å¾…æŠ€æœ¯æŒ‡æ ‡ä¿®å¤\n\n**å®‰å…¨ä¹°å…¥æ¡ä»¶ï¼š**\n- RSIå›è½è‡³50ä»¥ä¸‹\n- æˆäº¤é‡æ¢å¤æ­£å¸¸æ°´å¹³\n- ä»·æ ¼å……åˆ†å›è°ƒï¼ˆå»ºè®®å›è°ƒ20%ä»¥ä¸Šï¼‰\n\nğŸš¨ **é‡è¦æé†’**: è¯¥è‚¡å½“å‰é£é™©æé«˜ï¼Œå¼ºçƒˆå»ºè®®è§„é¿ã€‚å¦‚å·²æŒæœ‰ï¼Œå»ºè®®åˆ†æ‰¹å‡ä»“ä¿æŠ¤åˆ©æ¶¦ã€‚"
            }
        ]

        # æ„å»ºç®€åŒ–çš„Modelfile
        modelfile_content = f"""FROM deepseek-llm:latest
SYSTEM "{system_prompt}"
PARAMETER temperature 0.7
PARAMETER top_p 0.9
PARAMETER top_k 40
PARAMETER repeat_penalty 1.1
PARAMETER num_predict 1024"""

        return modelfile_content

    def create_model(self, model_name: str = "ljwx-stock") -> bool:
        """åˆ›å»ºljwx-stockæ¨¡å‹"""
        try:
            # ç”ŸæˆModelfile
            modelfile_content = self.create_ljwx_stock_modelfile()
            
            self.logger.info(f"ğŸš€ å¼€å§‹åˆ›å»ºæ¨¡å‹: {model_name}")
            
            # åˆ›å»ºä¸´æ—¶Modelfile
            import tempfile
            with tempfile.NamedTemporaryFile(mode='w', suffix='.modelfile', delete=False) as f:
                f.write(modelfile_content)
                modelfile_path = f.name
            
            try:
                # ä½¿ç”¨ollama createå‘½ä»¤
                import subprocess
                result = subprocess.run(
                    ['ollama', 'create', model_name, '-f', modelfile_path],
                    capture_output=True,
                    text=True,
                    timeout=300  # 5åˆ†é’Ÿè¶…æ—¶
                )
                
                if result.returncode == 0:
                    self.logger.info(f"âœ… æ¨¡å‹åˆ›å»ºå®Œæˆ: {model_name}")
                    print(f"   ğŸ“Š æ¨¡å‹åˆ›å»ºæˆåŠŸ")
                    return True
                else:
                    self.logger.error(f"âŒ æ¨¡å‹åˆ›å»ºå¤±è´¥: {result.stderr}")
                    print(f"   âŒ é”™è¯¯: {result.stderr}")
                    return False
                    
            finally:
                # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                os.unlink(modelfile_path)
                
        except Exception as e:
            self.logger.error(f"âŒ åˆ›å»ºæ¨¡å‹æ—¶å‡ºé”™: {e}")
            return False

    def test_model(self, model_name: str = "ljwx-stock") -> bool:
        """æµ‹è¯•åˆ›å»ºçš„æ¨¡å‹"""
        test_prompt = """åˆ†æä»¥ä¸‹è‚¡ç¥¨æ•°æ®å¹¶ç»™å‡ºæŠ•èµ„å»ºè®®ï¼š

è‚¡ç¥¨ä»£ç : 000002.SZ
å½“å‰ä»·æ ¼: 28.50å…ƒ
æ—¥æ¶¨è·Œå¹…: +2.3%
5æ—¥å‡çº¿: 27.80å…ƒ
20æ—¥å‡çº¿: 26.90å…ƒ
RSI: 58.5
æˆäº¤é‡: æ­£å¸¸"""

        try:
            self.logger.info(f"ğŸ§ª æµ‹è¯•æ¨¡å‹: {model_name}")
            
            data = {
                "model": model_name,
                "prompt": test_prompt,
                "stream": False
            }
            
            response = requests.post(
                f"{self.base_url}/api/generate",
                json=data,
                timeout=60
            )
            
            if response.status_code == 200:
                result = response.json()
                answer = result.get('response', '')
                
                if answer:
                    print(f"\nğŸ¯ æ¨¡å‹æµ‹è¯•ç»“æœ:")
                    print(f"ğŸ“ è¾“å…¥: {test_prompt[:50]}...")
                    print(f"ğŸ’¬ è¾“å‡º: {answer[:200]}...")
                    self.logger.info("âœ… æ¨¡å‹æµ‹è¯•æˆåŠŸ")
                    return True
                else:
                    self.logger.error("âŒ æ¨¡å‹æ— å“åº”")
                    return False
            else:
                self.logger.error(f"âŒ æµ‹è¯•å¤±è´¥: {response.status_code}")
                return False
                
        except Exception as e:
            self.logger.error(f"âŒ æµ‹è¯•æ¨¡å‹æ—¶å‡ºé”™: {e}")
            return False

def main():
    """ä¸»å‡½æ•°"""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s'
    )
    
    print("ğŸš€ ljwx-stock è‚¡ç¥¨åˆ†ææ¨¡å‹åˆ›å»ºå™¨")
    print("=" * 50)
    
    try:
        # åˆå§‹åŒ–åˆ›å»ºå™¨
        creator = LjwxStockModelCreator()
        
        # åˆ›å»ºæ¨¡å‹
        model_name = "ljwx-stock"
        success = creator.create_model(model_name)
        
        if success:
            print(f"\nâœ… {model_name} æ¨¡å‹åˆ›å»ºæˆåŠŸï¼")
            
            # æµ‹è¯•æ¨¡å‹
            test_success = creator.test_model(model_name)
            
            if test_success:
                print(f"\nğŸ‰ {model_name} æ¨¡å‹å·²å°±ç»ªï¼")
                print(f"\nğŸ¯ ä½¿ç”¨æ–¹æ³•:")
                print(f"   ollama run {model_name}")
                print(f"\nğŸ’¡ ç¤ºä¾‹é—®é¢˜:")
                print(f"   - åˆ†æä¸€ä¸‹000001.SZçš„æŠ•èµ„ä»·å€¼")
                print(f"   - è¯„ä¼°è‚¡ç¥¨ä»£ç 600000.SHçš„é£é™©ç­‰çº§")
                print(f"   - åŸºäºæŠ€æœ¯æŒ‡æ ‡é¢„æµ‹ä»·æ ¼è¶‹åŠ¿")
            else:
                print(f"âš ï¸ æ¨¡å‹åˆ›å»ºæˆåŠŸä½†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨éªŒè¯")
        else:
            print(f"âŒ {model_name} æ¨¡å‹åˆ›å»ºå¤±è´¥")
            
    except KeyboardInterrupt:
        print("\nâš ï¸ æ“ä½œè¢«ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\nâŒ åˆ›å»ºå¤±è´¥: {e}")

if __name__ == "__main__":
    main()