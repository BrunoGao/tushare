<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ljwx-stock æ™ºèƒ½æŠ•èµ„ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-header {
            background: var(--primary-gradient);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .main-header h1 {
            font-weight: 300;
            margin: 0;
        }
        
        .main-header .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            background: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #28a745;
        }
        
        .status-indicator.running {
            border-left-color: #ffc107;
        }
        
        .status-indicator.error {
            border-left-color: #dc3545;
        }
        
        .function-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: none;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .function-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 35px rgba(0,0,0,0.15);
        }
        
        .function-card .card-header {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 1.5rem;
            font-weight: 500;
        }
        
        .function-card.success .card-header {
            background: var(--success-gradient);
        }
        
        .function-card.warning .card-header {
            background: var(--warning-gradient);
        }
        
        .function-card.danger .card-header {
            background: var(--danger-gradient);
        }
        
        .metric-display {
            text-align: center;
            padding: 1rem;
        }
        
        .metric-display .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }
        
        .metric-display .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-gradient {
            background: var(--primary-gradient);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .progress-custom {
            height: 8px;
            border-radius: 10px;
            background-color: #e9ecef;
        }
        
        .progress-custom .progress-bar {
            border-radius: 10px;
            background: var(--primary-gradient);
        }
        
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            padding: 1rem;
            border-radius: 10px;
            height: 300px;
            overflow-y: auto;
        }
        
        .quick-action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .quick-action-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .quick-action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 35px rgba(0,0,0,0.15);
        }
        
        .quick-action-card .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .modal-custom .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .modal-custom .modal-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: 15px 15px 0 0;
            border: none;
        }
        
        .form-control-custom {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control-custom:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .recommendation-item {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }
        
        .recommendation-item.buy {
            border-left-color: #28a745;
        }
        
        .recommendation-item.sell {
            border-left-color: #dc3545;
        }
        
        .recommendation-item.hold {
            border-left-color: #ffc107;
        }
        
        @media (max-width: 768px) {
            .main-header {
                padding: 1rem 0;
            }
            
            .main-header h1 {
                font-size: 1.8rem;
            }
            
            .status-indicator {
                position: static;
                margin-bottom: 1rem;
            }
            
            .quick-action-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="status-indicator" id="statusIndicator">
        <i class="bi bi-circle-fill me-2"></i>
        <span id="statusText">ç³»ç»Ÿæ­£å¸¸</span>
    </div>

    <!-- ä¸»æ ‡é¢˜ -->
    <div class="main-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-graph-up me-3"></i>ljwx-stock æ™ºèƒ½æŠ•èµ„ç³»ç»Ÿ</h1>
                    <p class="subtitle mb-0">äººå·¥æ™ºèƒ½é©±åŠ¨çš„è‚¡ç¥¨åˆ†æä¸æŠ•èµ„å†³ç­–å¹³å°</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-light btn-sm" onclick="refreshDashboard()">
                            <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="showSettings()">
                            <i class="bi bi-gear me-1"></i>è®¾ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- ç³»ç»Ÿæ¦‚è§ˆ -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="metric-display function-card">
                    <div class="metric-value" id="totalModels">-</div>
                    <div class="metric-label">å¯ç”¨æ¨¡å‹</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-display function-card success">
                    <div class="metric-value" id="totalRecommendations">-</div>
                    <div class="metric-label">æ€»æ¨èæ•°</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-display function-card warning">
                    <div class="metric-value" id="hitRate">-</div>
                    <div class="metric-label">å‘½ä¸­ç‡</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-display function-card danger">
                    <div class="metric-value" id="totalStrategies">-</div>
                    <div class="metric-label">æŠ•èµ„ç­–ç•¥</div>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="quick-action-grid">
            <div class="quick-action-card" onclick="showStockRecommendation()">
                <div class="icon">
                    <i class="bi bi-star-fill"></i>
                </div>
                <h5>è‚¡ç¥¨æ¨è</h5>
                <p class="text-muted">AIæ™ºèƒ½åˆ†æç”ŸæˆæŠ•èµ„æ¨è</p>
            </div>
            
            <div class="quick-action-card" onclick="showQuickAnalysis()">
                <div class="icon">
                    <i class="bi bi-search"></i>
                </div>
                <h5>å¿«é€Ÿåˆ†æ</h5>
                <p class="text-muted">è¾“å…¥è‚¡ç¥¨ä»£ç è·å–å³æ—¶åˆ†æ</p>
            </div>
            
            <div class="quick-action-card" onclick="showModelTraining()">
                <div class="icon">
                    <i class="bi bi-cpu-fill"></i>
                </div>
                <h5>æ¨¡å‹è®­ç»ƒ</h5>
                <p class="text-muted">è®­ç»ƒä¸“å±AIæŠ•èµ„æ¨¡å‹</p>
            </div>
            
            <div class="quick-action-card" onclick="showStrategyManagement()">
                <div class="icon">
                    <i class="bi bi-bar-chart-line-fill"></i>
                </div>
                <h5>ç­–ç•¥ç®¡ç†</h5>
                <p class="text-muted">åˆ›å»ºå’Œå›æµ‹æŠ•èµ„ç­–ç•¥</p>
            </div>
            
            <div class="quick-action-card" onclick="showDataManagement()">
                <div class="icon">
                    <i class="bi bi-database-fill"></i>
                </div>
                <h5>æ•°æ®ç®¡ç†</h5>
                <p class="text-muted">ç®¡ç†è®­ç»ƒæ•°æ®å’Œå¸‚åœºæ•°æ®</p>
            </div>
            
            <div class="quick-action-card" onclick="showModelEvaluation()">
                <div class="icon">
                    <i class="bi bi-clipboard-check-fill"></i>
                </div>
                <h5>æ¨¡å‹è¯„ä¼°</h5>
                <p class="text-muted">è¯„ä¼°æ¨¡å‹æ€§èƒ½å’Œå‡†ç¡®æ€§</p>
            </div>
        </div>

        <!-- ä¸»è¦åŠŸèƒ½åŒºåŸŸ -->
        <div class="row">
            <!-- æœ€æ–°æ¨è -->
            <div class="col-lg-6 mb-4">
                <div class="function-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-star me-2"></i>æœ€æ–°æ¨è</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="refreshRecommendations()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="latestRecommendations">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-star fs-1 d-block mb-2"></i>
                                æš‚æ— æ¨èæ•°æ®ï¼Œç‚¹å‡»"è‚¡ç¥¨æ¨è"å¼€å§‹ç”Ÿæˆ
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»Ÿæ—¥å¿— -->
            <div class="col-lg-6 mb-4">
                <div class="function-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-terminal me-2"></i>ç³»ç»Ÿæ—¥å¿—</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="clearLogs()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="log-container" id="logContainer">
                            <div>ç³»ç»Ÿå·²å¯åŠ¨ï¼Œç­‰å¾…æ“ä½œ...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="row" id="progressSection" style="display: none;">
            <div class="col-12">
                <div class="function-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-activity me-2"></i>ä»»åŠ¡è¿›åº¦</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress-custom progress mb-3">
                            <div class="progress-bar" id="globalProgress" style="width: 0%"></div>
                        </div>
                        <p class="mb-0" id="currentTask">ç­‰å¾…ä»»åŠ¡...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è‚¡ç¥¨æ¨èæ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="stockRecommendationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-star me-2"></i>ç”Ÿæˆè‚¡ç¥¨æ¨è</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recommendationForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">é€‰æ‹©æ¨¡å‹</label>
                                <select class="form-select form-control-custom" id="recModelSelect" required>
                                    <option value="">é€‰æ‹©æ¨èæ¨¡å‹</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">æ¨èæ•°é‡</label>
                                <select class="form-select form-control-custom" id="numStocks">
                                    <option value="3">3åªè‚¡ç¥¨</option>
                                    <option value="5" selected>5åªè‚¡ç¥¨</option>
                                    <option value="10">10åªè‚¡ç¥¨</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">åˆ†æç±»å‹</label>
                                <select class="form-select form-control-custom" id="analysisType">
                                    <option value="comprehensive_analysis" selected>ç»¼åˆåˆ†æ</option>
                                    <option value="technical_analysis">æŠ€æœ¯åˆ†æ</option>
                                    <option value="risk_assessment">é£é™©è¯„ä¼°</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">TuShare Tokenï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" class="form-control form-control-custom" id="recTushareToken" 
                                       placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤é…ç½®">
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="useDailyMode" checked>
                            <label class="form-check-label" for="useDailyMode">
                                ä½¿ç”¨æ¯æ—¥æ¨èæ¨¡å¼ï¼ˆè‡ªåŠ¨é€‰æ‹©æ´»è·ƒè‚¡ç¥¨ï¼‰
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-gradient" onclick="generateRecommendations()">
                        <i class="bi bi-star-fill me-1"></i>ç”Ÿæˆæ¨è
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿåˆ†ææ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="quickAnalysisModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-search me-2"></i>å¿«é€Ÿè‚¡ç¥¨åˆ†æ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="quickAnalysisForm">
                        <div class="mb-3">
                            <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                            <input type="text" class="form-control form-control-custom" id="quickStockCode" 
                                   placeholder="ä¾‹å¦‚ï¼š000001.SZ" required>
                            <div class="form-text">æ”¯æŒæ·±äº¤æ‰€(.SZ)å’Œä¸Šäº¤æ‰€(.SH)ä»£ç </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">åˆ†æç±»å‹</label>
                            <select class="form-select form-control-custom" id="quickAnalysisType">
                                <option value="quick" selected>å¿«é€Ÿåˆ†æ</option>
                                <option value="detailed">è¯¦ç»†åˆ†æ</option>
                            </select>
                        </div>
                    </form>
                    <div id="quickAnalysisResult" style="display: none;">
                        <hr>
                        <h6>åˆ†æç»“æœ</h6>
                        <div id="quickAnalysisOutput"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-gradient" onclick="runQuickAnalysis()">
                        <i class="bi bi-search me-1"></i>å¼€å§‹åˆ†æ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡å‹è®­ç»ƒæ¨¡æ€æ¡† -->
    <div class="modal fade modal-custom" id="modelTrainingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cpu me-2"></i>æ¨¡å‹è®­ç»ƒ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="modelTrainingForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">åŸºç¡€æ¨¡å‹</label>
                                <select class="form-select form-control-custom" id="baseModel">
                                    <option value="ljwx-stock" selected>ljwx-stock</option>
                                    <option value="deepseek-coder">deepseek-coder</option>
                                    <option value="qwen">qwen</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">è®­ç»ƒæ•°æ®æ–‡ä»¶</label>
                                <select class="form-select form-control-custom" id="trainingFile" required>
                                    <option value="">é€‰æ‹©è®­ç»ƒæ•°æ®æ–‡ä»¶</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">æ–°æ¨¡å‹åç§°</label>
                                <input type="text" class="form-control form-control-custom" id="modelName" 
                                       placeholder="è‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">è®­ç»ƒæ ·æœ¬æ•°é‡</label>
                                <input type="number" class="form-control form-control-custom" id="sampleCount" 
                                       value="200" min="50" max="1000">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-gradient" onclick="startModelTraining()">
                        <i class="bi bi-play-fill me-1"></i>å¼€å§‹è®­ç»ƒ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    
    <script>
        // WebSocketè¿æ¥
        const socket = io();
        
        // å…¨å±€çŠ¶æ€
        let systemStatus = {
            is_running: false,
            progress: 0,
            current_task: '',
            logs: []
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadDashboardData();
            setupEventListeners();
        });

        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            console.log('ljwx-stock ç»Ÿä¸€åº”ç”¨å·²å¯åŠ¨');
            updateStatusIndicator();
            
            // Socket.IOäº‹ä»¶ç›‘å¬
            socket.on('connected', function(data) {
                addLog('WebSocketè¿æ¥æˆåŠŸ', 'success');
            });

            socket.on('log_update', function(data) {
                addLog(data.message, data.level);
            });

            socket.on('progress_update', function(data) {
                updateProgress(data.progress, data.task);
            });

            socket.on('task_completed', function(data) {
                handleTaskCompleted(data);
            });

            socket.on('task_failed', function(data) {
                handleTaskFailed(data);
            });

            socket.on('recommendation_generated', function(data) {
                addLog(`âœ… æ¨èç”Ÿæˆå®Œæˆ: ${data.total_recommendations} ä¸ª`, 'success');
                refreshRecommendations();
                refreshDashboard();
            });

            socket.on('validation_completed', function(data) {
                addLog(`âœ… æ¨èéªŒè¯å®Œæˆ: ${data.validated_count} æ¡`, 'success');
                refreshRecommendations();
                refreshDashboard();
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ¨èè¡¨å•
            document.getElementById('recommendationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                generateRecommendations();
            });

            // å¿«é€Ÿåˆ†æè¡¨å•
            document.getElementById('quickAnalysisForm').addEventListener('submit', function(e) {
                e.preventDefault();
                runQuickAnalysis();
            });

            // æ¨¡å‹è®­ç»ƒè¡¨å•
            document.getElementById('modelTrainingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                startModelTraining();
            });
        }

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        function loadDashboardData() {
            // åŠ è½½ç³»ç»ŸçŠ¶æ€
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    systemStatus = data;
                    updateStatusIndicator();
                });

            // åŠ è½½ç§»åŠ¨ç«¯ä»ªè¡¨æ¿æ•°æ®
            fetch('/api/mobile/dashboard')
                .then(response => response.json())
                .then(data => {
                    updateDashboardMetrics(data);
                })
                .catch(error => {
                    console.error('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', error);
                });

            // åŠ è½½æ¨¡å‹ä¿¡æ¯
            fetch('/api/models-info')
                .then(response => response.json())
                .then(data => {
                    updateModelSelects(data.models || []);
                });

            // åŠ è½½è®­ç»ƒæ•°æ®ä¿¡æ¯
            fetch('/api/training-data-info')
                .then(response => response.json())
                .then(data => {
                    updateTrainingFileSelect(data.files || []);
                });

            // åŠ è½½æœ€æ–°æ¨è
            refreshRecommendations();
        }

        // æ›´æ–°ä»ªè¡¨æ¿æŒ‡æ ‡
        function updateDashboardMetrics(data) {
            if (data.training_summary) {
                document.getElementById('totalModels').textContent = data.training_summary.total_models || '-';
            }
            
            if (data.recommendation_summary) {
                document.getElementById('totalRecommendations').textContent = data.recommendation_summary.total_recommendations || '-';
                const hitRate = data.recommendation_summary.hit_rate || 0;
                document.getElementById('hitRate').textContent = (hitRate * 100).toFixed(1) + '%';
            }
            
            if (data.strategy_summary) {
                document.getElementById('totalStrategies').textContent = data.strategy_summary.total_strategies || '-';
            }
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatusIndicator() {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (systemStatus.is_running) {
                indicator.className = 'status-indicator running';
                statusText.textContent = 'å¤„ç†ä¸­...';
            } else {
                indicator.className = 'status-indicator';
                statusText.textContent = 'ç³»ç»Ÿæ­£å¸¸';
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(progress, task) {
            systemStatus.progress = progress;
            systemStatus.current_task = task;
            
            const progressBar = document.getElementById('globalProgress');
            const taskText = document.getElementById('currentTask');
            const progressSection = document.getElementById('progressSection');
            
            if (progress > 0 && progress < 100) {
                progressSection.style.display = 'block';
            } else if (progress >= 100) {
                setTimeout(() => {
                    progressSection.style.display = 'none';
                }, 3000);
            }
            
            progressBar.style.width = progress + '%';
            taskText.textContent = task || '';
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, level = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
            
            if (level === 'error') {
                logEntry.style.color = '#ff6b6b';
            } else if (level === 'warning') {
                logEntry.style.color = '#feca57';
            } else if (level === 'success') {
                logEntry.style.color = '#48dbfb';
            }

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // é™åˆ¶æ—¥å¿—æ¡æ•°
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            fetch('/api/clear-logs', { method: 'POST' })
                .then(() => {
                    document.getElementById('logContainer').innerHTML = '';
                    addLog('æ—¥å¿—å·²æ¸…é™¤');
                });
        }

        // åˆ·æ–°ä»ªè¡¨æ¿
        function refreshDashboard() {
            loadDashboardData();
            addLog('ä»ªè¡¨æ¿æ•°æ®å·²åˆ·æ–°');
        }

        // åˆ·æ–°æ¨è
        function refreshRecommendations() {
            fetch('/api/mobile/recommendations/latest?limit=5')
                .then(response => response.json())
                .then(data => {
                    displayLatestRecommendations(data.recommendations || []);
                })
                .catch(error => {
                    console.error('åŠ è½½æ¨èå¤±è´¥:', error);
                });
        }

        // æ˜¾ç¤ºæœ€æ–°æ¨è
        function displayLatestRecommendations(recommendations) {
            const container = document.getElementById('latestRecommendations');
            
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-star fs-1 d-block mb-2"></i>
                        æš‚æ— æ¨èæ•°æ®ï¼Œç‚¹å‡»"è‚¡ç¥¨æ¨è"å¼€å§‹ç”Ÿæˆ
                    </div>
                `;
                return;
            }

            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-item ${rec.recommendation_type}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${rec.stock_name} (${rec.stock_code})</h6>
                            <span class="badge bg-${getRecommendationTypeColor(rec.recommendation_type)} me-2">
                                ${getRecommendationTypeLabel(rec.recommendation_type)}
                            </span>
                            <small class="text-muted">ç½®ä¿¡åº¦: ${(rec.confidence_score * 100).toFixed(0)}%</small>
                        </div>
                        <div class="text-end">
                            ${rec.actual_return ? 
                                `<span class="text-${rec.actual_return >= 0 ? 'success' : 'danger'}">
                                    ${(rec.actual_return * 100).toFixed(2)}%
                                </span>` : 
                                '<span class="text-muted">å¾…éªŒè¯</span>'
                            }
                            <br>
                            <small class="text-muted">${formatTime(rec.created_time)}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºè‚¡ç¥¨æ¨èæ¨¡æ€æ¡†
        function showStockRecommendation() {
            const modal = new bootstrap.Modal(document.getElementById('stockRecommendationModal'));
            modal.show();
        }

        // ç”Ÿæˆæ¨è
        function generateRecommendations() {
            if (systemStatus.is_running) {
                alert('å½“å‰æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œè¯·ç­‰å¾…å®Œæˆ');
                return;
            }

            const config = {
                model_name: document.getElementById('recModelSelect').value,
                num_stocks: parseInt(document.getElementById('numStocks').value),
                analysis_type: document.getElementById('analysisType').value,
                use_daily_mode: document.getElementById('useDailyMode').checked,
                tushare_token: document.getElementById('recTushareToken').value
            };

            if (!config.model_name) {
                alert('è¯·é€‰æ‹©æ¨èæ¨¡å‹');
                return;
            }

            fetch('/api/recommendations/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    bootstrap.Modal.getInstance(document.getElementById('stockRecommendationModal')).hide();
                    addLog(`ğŸš€ å¼€å§‹ç”Ÿæˆæ¨è: ${config.model_name}`, 'info');
                    systemStatus.is_running = true;
                    updateStatusIndicator();
                } else {
                    alert('æ¨èç”Ÿæˆå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('ç”Ÿæˆæ¨èå¤±è´¥:', error);
                alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
            });
        }

        // æ˜¾ç¤ºå¿«é€Ÿåˆ†ææ¨¡æ€æ¡†
        function showQuickAnalysis() {
            const modal = new bootstrap.Modal(document.getElementById('quickAnalysisModal'));
            modal.show();
        }

        // è¿è¡Œå¿«é€Ÿåˆ†æ
        function runQuickAnalysis() {
            const stockCode = document.getElementById('quickStockCode').value;
            const analysisType = document.getElementById('quickAnalysisType').value;
            
            if (!stockCode.trim()) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            const resultDiv = document.getElementById('quickAnalysisResult');
            const outputDiv = document.getElementById('quickAnalysisOutput');
            
            resultDiv.style.display = 'block';
            outputDiv.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split me-2"></i>åˆ†æä¸­...</div>';

            fetch('/api/mobile/quick-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    stock_code: stockCode,
                    analysis_type: analysisType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    outputDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    displayQuickAnalysisResult(data.analysis);
                }
            })
            .catch(error => {
                outputDiv.innerHTML = `<div class="alert alert-danger">åˆ†æå¤±è´¥: ${error.message}</div>`;
            });
        }

        // æ˜¾ç¤ºå¿«é€Ÿåˆ†æç»“æœ
        function displayQuickAnalysisResult(analysis) {
            const outputDiv = document.getElementById('quickAnalysisOutput');
            
            if (analysis.error) {
                outputDiv.innerHTML = `<div class="alert alert-danger">${analysis.error}</div>`;
                return;
            }

            outputDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>ä»·æ ¼ä¿¡æ¯</h6>
                        <p>å½“å‰ä»·æ ¼: Â¥${analysis.current_price}</p>
                        <p>æ¶¨è·Œå¹…: <span class="text-${analysis.price_change >= 0 ? 'success' : 'danger'}">${analysis.price_change.toFixed(2)}%</span></p>
                        <p>æˆäº¤é‡: ${(analysis.volume / 10000).toFixed(2)}ä¸‡æ‰‹</p>
                    </div>
                    <div class="col-md-6">
                        <h6>æŠ€æœ¯æŒ‡æ ‡</h6>
                        <p>5æ—¥å‡çº¿: Â¥${analysis.ma5.toFixed(2)}</p>
                        <p>20æ—¥å‡çº¿: Â¥${analysis.ma20.toFixed(2)}</p>
                        <p>è¶‹åŠ¿: <span class="badge bg-${analysis.trend === 'ä¸Šæ¶¨' ? 'success' : 'danger'}">${analysis.trend}</span></p>
                    </div>
                </div>
                <div class="alert alert-info mt-3">
                    <small>åˆ†ææ—¶é—´: ${analysis.analysis_time}</small>
                </div>
            `;
        }

        // æ˜¾ç¤ºæ¨¡å‹è®­ç»ƒæ¨¡æ€æ¡†
        function showModelTraining() {
            const modal = new bootstrap.Modal(document.getElementById('modelTrainingModal'));
            modal.show();
        }

        // å¼€å§‹æ¨¡å‹è®­ç»ƒ
        function startModelTraining() {
            if (systemStatus.is_running) {
                alert('å½“å‰æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œè¯·ç­‰å¾…å®Œæˆ');
                return;
            }

            const config = {
                base_model: document.getElementById('baseModel').value,
                training_file: document.getElementById('trainingFile').value,
                model_name: document.getElementById('modelName').value || 
                           `ljwx-stock-unified-${new Date().toISOString().slice(0,16).replace(/[-:]/g, '')}`,
                sample_count: parseInt(document.getElementById('sampleCount').value)
            };

            if (!config.training_file) {
                alert('è¯·é€‰æ‹©è®­ç»ƒæ•°æ®æ–‡ä»¶');
                return;
            }

            fetch('/api/train-model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    bootstrap.Modal.getInstance(document.getElementById('modelTrainingModal')).hide();
                    addLog('ğŸš€ å¼€å§‹è®­ç»ƒæ¨¡å‹: ' + config.model_name, 'info');
                    systemStatus.is_running = true;
                    updateStatusIndicator();
                } else {
                    alert('è®­ç»ƒå¯åŠ¨å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('å¯åŠ¨è®­ç»ƒå¤±è´¥:', error);
                alert('å¯åŠ¨å¤±è´¥: ' + error.message);
            });
        }

        // å…¶ä»–åŠŸèƒ½çš„å ä½å‡½æ•°
        function showStrategyManagement() {
            addLog('ç­–ç•¥ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        function showDataManagement() {
            addLog('æ•°æ®ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        function showModelEvaluation() {
            addLog('æ¨¡å‹è¯„ä¼°åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        function showSettings() {
            addLog('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // æ›´æ–°æ¨¡å‹é€‰æ‹©æ¡†
        function updateModelSelects(models) {
            const select = document.getElementById('recModelSelect');
            select.innerHTML = '<option value="">é€‰æ‹©æ¨èæ¨¡å‹</option>' +
                models.map(model => `<option value="${model.name}">${model.name}</option>`).join('');
        }

        // æ›´æ–°è®­ç»ƒæ–‡ä»¶é€‰æ‹©æ¡†
        function updateTrainingFileSelect(files) {
            const select = document.getElementById('trainingFile');
            select.innerHTML = '<option value="">é€‰æ‹©è®­ç»ƒæ•°æ®æ–‡ä»¶</option>' +
                files.map(file => `<option value="${file.filename}">${file.filename} (${file.sample_count}æ ·æœ¬)</option>`).join('');
        }

        // ä»»åŠ¡å®Œæˆå¤„ç†
        function handleTaskCompleted(data) {
            systemStatus.is_running = false;
            updateStatusIndicator();
            updateProgress(100, 'ä»»åŠ¡å®Œæˆ');
            
            if (data.type === 'data_generation') {
                addLog(`âœ… æ•°æ®ç”Ÿæˆå®Œæˆï¼š${data.sample_count} ä¸ªæ ·æœ¬`, 'success');
                loadDashboardData();
            } else if (data.type === 'model_training') {
                addLog(`âœ… æ¨¡å‹è®­ç»ƒå®Œæˆï¼š${data.model_name}`, 'success');
                loadDashboardData();
            }
        }

        function handleTaskFailed(data) {
            systemStatus.is_running = false;
            updateStatusIndicator();
            addLog(`âŒ ä»»åŠ¡å¤±è´¥ï¼š${data.error}`, 'error');
        }

        // å·¥å…·å‡½æ•°
        function getRecommendationTypeColor(type) {
            const colors = {
                'buy': 'success',
                'sell': 'danger',
                'hold': 'warning',
                'neutral': 'secondary'
            };
            return colors[type] || 'secondary';
        }

        function getRecommendationTypeLabel(type) {
            const labels = {
                'buy': 'ä¹°å…¥',
                'sell': 'å–å‡º',
                'hold': 'æŒæœ‰',
                'neutral': 'ä¸­æ€§'
            };
            return labels[type] || type;
        }

        function formatTime(timeStr) {
            try {
                const date = new Date(timeStr);
                return date.toLocaleString('zh-CN');
            } catch {
                return timeStr;
            }
        }
    </script>
</body>
</html>