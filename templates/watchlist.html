{% extends "base.html" %}

{% block title %}自选股 - 灵境万象{% endblock %}

{% block content %}
<div x-data="watchlistApp()" x-cloak>
    <!-- 页面头部 -->
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">我的自选股</h1>
        <p class="mt-1 text-gray-600">管理和监控您关注的股票</p>
    </div>
    
    <!-- 添加股票 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-6">
        <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
                <div class="relative">
                    <input 
                        type="text" 
                        x-model="searchQuery"
                        @input="searchStocks"
                        placeholder="搜索股票代码或名称..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                    >
                    <div x-show="searchResults.length > 0" 
                         class="absolute top-full mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg z-10">
                        <template x-for="stock in searchResults" :key="stock.ts_code">
                            <div @click="addToWatchlist(stock)" 
                                 class="px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0">
                                <div class="font-medium text-sm" x-text="stock.display_name"></div>
                                <div class="text-xs text-gray-500" x-text="stock.ts_code"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <button @click="clearSearch()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                清空
            </button>
        </div>
    </div>
    
    <!-- 自选股列表 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-4 sm:p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-900">自选股列表</h2>
                <div class="flex space-x-2">
                    <button @click="refreshAll()" class="text-purple-600 hover:text-purple-700">
                        <i data-lucide="refresh-cw" class="h-5 w-5"></i>
                    </button>
                    <button @click="exportWatchlist()" class="text-purple-600 hover:text-purple-700">
                        <i data-lucide="download" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <th class="px-6 py-3">股票</th>
                        <th class="px-6 py-3 text-right">现价</th>
                        <th class="px-6 py-3 text-right">涨跌</th>
                        <th class="px-6 py-3 text-right">涨跌幅</th>
                        <th class="px-6 py-3 text-right">成交量</th>
                        <th class="px-6 py-3 text-center">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="stock in watchlist" :key="stock.ts_code">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div>
                                    <div class="text-sm font-medium text-gray-900" x-text="stock.name"></div>
                                    <div class="text-sm text-gray-500" x-text="stock.ts_code"></div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium" 
                                x-text="formatNumber(stock.close)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm" 
                                :class="stock.change >= 0 ? 'text-bull' : 'text-bear'" 
                                x-text="stock.change >= 0 ? '+' + formatNumber(stock.change) : formatNumber(stock.change)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm" 
                                :class="stock.pct_chg >= 0 ? 'text-bull' : 'text-bear'" 
                                x-text="formatPercent(stock.pct_chg)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-500" 
                                x-text="formatNumber(stock.vol/10000, 0) + '万'"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                <div class="flex justify-center space-x-2">
                                    <button @click="viewStock(stock.ts_code)" 
                                            class="text-purple-600 hover:text-purple-700">分析</button>
                                    <button @click="removeFromWatchlist(stock.ts_code)" 
                                            class="text-red-600 hover:text-red-700">删除</button>
                                </div>
                            </td>
                        </tr>
                    </template>
                    
                    <tr x-show="watchlist.length === 0">
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                            <i data-lucide="bookmark" class="h-12 w-12 mx-auto mb-4 text-gray-300"></i>
                            <p>暂无自选股</p>
                            <p class="text-sm">搜索并添加您关注的股票</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function watchlistApp() {
    return {
        searchQuery: '',
        searchResults: [],
        watchlist: [],
        
        init() {
            this.loadWatchlist();
        },
        
        async searchStocks() {
            if (this.searchQuery.length < 2) {
                this.searchResults = [];
                return;
            }
            
            try {
                const response = await apiRequest(`/api/stocks/search?q=${encodeURIComponent(this.searchQuery)}&limit=8`);
                this.searchResults = response.data || [];
            } catch (error) {
                this.searchResults = [];
            }
        },
        
        addToWatchlist(stock) {
            const exists = this.watchlist.find(s => s.ts_code === stock.ts_code);
            if (!exists) {
                this.watchlist.push({
                    ts_code: stock.ts_code,
                    name: stock.display_name,
                    close: 0,
                    change: 0,
                    pct_chg: 0,
                    vol: 0
                });
                this.saveWatchlist();
                showToast('已添加到自选股');
                this.refreshStock(stock.ts_code);
            } else {
                showToast('股票已在自选股中', 'error');
            }
            this.clearSearch();
        },
        
        removeFromWatchlist(tsCode) {
            this.watchlist = this.watchlist.filter(s => s.ts_code !== tsCode);
            this.saveWatchlist();
            showToast('已从自选股移除');
        },
        
        async refreshStock(tsCode) {
            try {
                const response = await apiRequest(`/api/stocks/quote/${tsCode}`);
                if (response.success) {
                    const stock = this.watchlist.find(s => s.ts_code === tsCode);
                    if (stock) {
                        Object.assign(stock, response.data);
                    }
                }
            } catch (error) {
                console.error('刷新股票数据失败:', error);
            }
        },
        
        async refreshAll() {
            showToast('正在刷新数据...', 'info');
            for (const stock of this.watchlist) {
                await this.refreshStock(stock.ts_code);
            }
            showToast('数据刷新完成');
        },
        
        viewStock(tsCode) {
            window.location.href = `/analysis?code=${tsCode}`;
        },
        
        clearSearch() {
            this.searchQuery = '';
            this.searchResults = [];
        },
        
        loadWatchlist() {
            const saved = localStorage.getItem('watchlist');
            if (saved) {
                this.watchlist = JSON.parse(saved);
                this.refreshAll();
            }
        },
        
        saveWatchlist() {
            localStorage.setItem('watchlist', JSON.stringify(this.watchlist));
        },
        
        exportWatchlist() {
            const data = this.watchlist.map(stock => ({
                代码: stock.ts_code,
                名称: stock.name,
                现价: stock.close,
                涨跌: stock.change,
                涨跌幅: stock.pct_chg + '%'
            }));
            
            const csv = this.convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '自选股_' + new Date().toLocaleDateString() + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        },
        
        convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ];
            
            return csv.join('\n');
        }
    }
}
</script>
{% endblock %}