<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ljwx-stock 智能投资决策平台</title>
    
    <!-- 本地化资源 - 立即加载 -->
    <link href="{{ url_for('static', filename='vendor/bootstrap/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='vendor/bootstrap-icons/bootstrap-icons.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/app.css') }}" rel="stylesheet">
    
    <!-- 简化的关键样式 -->
    <style>
        :root {
            --primary: #0066cc; --success: #198754; --warning: #fd7e14; --danger: #dc3545;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; margin: 0; }
        .top-navbar { background: linear-gradient(135deg, var(--primary), #004d99); color: white; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.875rem; }
        .status-badge.success { background: var(--success); color: white; }
        .status-badge.warning { background: var(--warning); color: white; }
        .status-badge.danger { background: var(--danger); color: white; }
        .metric-card { background: white; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #dee2e6; }
        .loading-skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="navbar navbar-expand-lg top-navbar">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up me-2"></i>ljwx-stock
            </a>
            <div class="ms-auto">
                <span id="systemStatus" class="status-badge success">
                    <i class="bi bi-circle-fill me-1"></i>系统正常
                </span>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container my-4">
        <!-- 页面标题 -->
        <div class="metric-card p-4 mb-4">
            <h1 class="mb-2">智能投资决策平台</h1>
            <p class="text-muted mb-0">基于AI的股票分析与推荐系统</p>
        </div>

        <!-- 关键指标 -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="metric-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">AI模型</small>
                            <h4 id="totalModels" class="mb-0">-</h4>
                        </div>
                        <i class="bi bi-cpu text-primary" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">推荐总数</small>
                            <h4 id="totalRecommendations" class="mb-0">-</h4>
                        </div>
                        <i class="bi bi-star text-warning" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">命中率</small>
                            <h4 id="hitRate" class="mb-0">-</h4>
                        </div>
                        <i class="bi bi-lightning text-success" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="metric-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">策略数</small>
                            <h4 id="totalStrategies" class="mb-0">-</h4>
                        </div>
                        <i class="bi bi-gear text-info" style="font-size: 1.5rem;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速分析 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="metric-card p-4">
                    <h5 class="mb-3">快速股票分析</h5>
                    <div class="row">
                        <div class="col-8">
                            <input type="text" class="form-control" id="quickStockCode" placeholder="输入股票代码 (如: 600028)" value="600028">
                        </div>
                        <div class="col-4">
                            <button class="btn btn-primary w-100" onclick="runQuickAnalysis()">分析</button>
                        </div>
                    </div>
                    <div id="quickAnalysisResult" class="mt-3"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="metric-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">最新推荐</h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="showRecommendationModal()">
                            <i class="bi bi-star me-1"></i>生成推荐
                        </button>
                    </div>
                    <div id="latestRecommendations">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-star fs-1 d-block mb-2"></i>
                            <p class="mb-0">加载中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 推荐生成模态框 -->
    <div class="modal fade" id="recommendationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-star me-2"></i>生成股票推荐
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">推荐模型</label>
                        <select class="form-select" id="recModelSelect">
                            <option value="">选择AI模型</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">推荐数量</label>
                        <select class="form-select" id="numStocks">
                            <option value="3">3只股票</option>
                            <option value="5" selected>5只股票</option>
                            <option value="10">10只股票</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useDailyMode" checked>
                            <label class="form-check-label" for="useDailyMode">
                                启用每日推荐模式（自动选择市场活跃股票）
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">TuShare Token（可选）</label>
                        <input type="text" class="form-control" id="recTushareToken" placeholder="留空使用系统配置">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="generateRecommendations()">
                        <i class="bi bi-star me-1"></i>生成推荐
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 简化的JS -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class SimpleApp {
            constructor() {
                this.socket = io();
                this.init();
            }
            
            init() {
                this.socket.on('connected', () => console.log('Connected'));
                this.socket.on('recommendation_generated', (data) => {
                    console.log('推荐生成完成:', data);
                    this.handleRecommendationGenerated(data);
                });
                this.socket.on('task_failed', (data) => {
                    console.error('任务失败:', data);
                    this.handleTaskFailed(data);
                });
                this.loadData();
                setInterval(() => this.loadData(), 60000);
            }
            
            handleRecommendationGenerated(data) {
                const container = document.getElementById('latestRecommendations');
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>生成完成!</strong> 
                        使用模型 ${data.model_name} 生成了 ${data.total_recommendations} 个推荐
                    </div>
                `;
                
                // 重新加载推荐数据
                setTimeout(() => {
                    this.loadRecommendations();
                }, 1000);
            }
            
            handleTaskFailed(data) {
                const container = document.getElementById('latestRecommendations');
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>生成失败:</strong> ${data.error}
                    </div>
                `;
            }
            
            async loadRecommendations() {
                try {
                    const recs = await fetch('/api/mobile/recommendations/latest?limit=3').then(r => r.json());
                    this.updateRecommendations(recs.recommendations || []);
                } catch (e) {
                    console.error('加载推荐失败:', e);
                }
            }
            
            async loadData() {
                try {
                    const [status, dashboard, models] = await Promise.all([
                        fetch('/api/status').then(r => r.json()),
                        fetch('/api/mobile/dashboard').then(r => r.json()),
                        fetch('/api/models-info').then(r => r.json())
                    ]);
                    
                    this.updateMetrics(dashboard);
                    this.updateModelSelects(models.models || []);
                    
                    const recs = await fetch('/api/mobile/recommendations/latest?limit=3').then(r => r.json());
                    this.updateRecommendations(recs.recommendations || []);
                } catch (e) {
                    console.error('Load failed:', e);
                }
            }
            
            updateModelSelects(models) {
                const select = document.getElementById('recModelSelect');
                if (select) {
                    select.innerHTML = '<option value="">选择AI模型</option>' +
                        models.map(model => 
                            `<option value="${model.name}">${model.name} (${model.size})</option>`
                        ).join('');
                }
            }
            
            updateMetrics(data) {
                document.getElementById('totalModels').textContent = data.training_summary?.total_models || 0;
                document.getElementById('totalRecommendations').textContent = data.recommendation_summary?.total_recommendations || 0;
                document.getElementById('hitRate').textContent = ((data.recommendation_summary?.hit_rate || 0) * 100).toFixed(1) + '%';
                document.getElementById('totalStrategies').textContent = data.strategy_summary?.total_strategies || 0;
            }
            
            updateRecommendations(recs) {
                const container = document.getElementById('latestRecommendations');
                if (recs.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-star fs-1 d-block mb-2"></i><p class="mb-0">暂无推荐</p></div>';
                    return;
                }
                
                container.innerHTML = recs.map(rec => `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>${rec.stock_name || rec.stock_code}</strong>
                            <small class="text-muted d-block">${rec.stock_code}</small>
                        </div>
                        <div class="text-end">
                            <span class="status-badge ${this.getTypeClass(rec.recommendation_type)}">${this.getTypeLabel(rec.recommendation_type)}</span>
                            <small class="text-muted d-block">${(rec.confidence_score * 100).toFixed(0)}%</small>
                        </div>
                    </div>
                `).join('');
            }
            
            getTypeClass(type) {
                return {'buy': 'success', 'sell': 'danger', 'hold': 'warning'}[type] || 'secondary';
            }
            
            getTypeLabel(type) {
                return {'buy': '买入', 'sell': '卖出', 'hold': '持有'}[type] || type;
            }
        }
        
        // 推荐生成功能
        function showRecommendationModal() {
            const modal = new bootstrap.Modal(document.getElementById('recommendationModal'));
            modal.show();
        }
        
        async function generateRecommendations() {
            const modelName = document.getElementById('recModelSelect').value;
            const numStocks = parseInt(document.getElementById('numStocks').value);
            const useDailyMode = document.getElementById('useDailyMode').checked;
            const tushareToken = document.getElementById('recTushareToken').value;
            
            if (!modelName) {
                alert('请选择AI模型');
                return;
            }
            
            const config = {
                model_name: modelName,
                num_stocks: numStocks,
                use_daily_mode: useDailyMode,
                analysis_type: 'comprehensive_analysis'
            };
            
            if (tushareToken.trim()) {
                config.tushare_token = tushareToken.trim();
            }
            
            try {
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('recommendationModal'));
                modal.hide();
                
                // 显示生成中状态
                const container = document.getElementById('latestRecommendations');
                container.innerHTML = `
                    <div class="text-center text-primary py-4">
                        <div class="spinner-border mb-2"></div>
                        <p class="mb-0">正在生成推荐...</p>
                        <small class="text-muted">使用模型: ${modelName}</small>
                    </div>
                `;
                
                const response = await fetch('/api/recommendations/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.status === 'started') {
                    console.log('推荐生成已启动');
                    // 状态会通过WebSocket更新
                } else {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            推荐生成失败: ${data.error || '未知错误'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('生成推荐失败:', error);
                document.getElementById('latestRecommendations').innerHTML = `
                    <div class="alert alert-danger">
                        网络错误: ${error.message}
                    </div>
                `;
            }
        }
        
        // 快速分析功能
        async function runQuickAnalysis() {
            const stockCode = document.getElementById('quickStockCode').value.trim();
            const resultDiv = document.getElementById('quickAnalysisResult');
            
            if (!stockCode) {
                resultDiv.innerHTML = '<div class="alert alert-warning">请输入股票代码</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>分析中...</div>';
            
            try {
                const response = await fetch('/api/mobile/quick-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_code: stockCode })
                });
                
                const data = await response.json();
                
                if (data.error || data.analysis?.error) {
                    const error = data.error || data.analysis.error;
                    const suggestion = data.analysis?.suggestion || '请检查股票代码格式';
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>分析失败:</strong> ${error}<br>
                            <small>${suggestion}</small>
                        </div>
                    `;
                } else {
                    const analysis = data.analysis;
                    resultDiv.innerHTML = `
                        <div class="mt-2">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">当前价格</small>
                                    <div class="fw-bold">¥${analysis.current_price}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">涨跌幅</small>
                                    <div class="fw-bold ${analysis.price_change >= 0 ? 'text-success' : 'text-danger'}">
                                        ${analysis.price_change >= 0 ? '+' : ''}${analysis.price_change.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <small class="text-muted">成交量</small>
                                    <div class="fw-bold">${(analysis.volume / 10000).toFixed(2)}万手</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">趋势</small>
                                    <div>
                                        <span class="status-badge ${analysis.trend === '上涨' ? 'success' : 'danger'}">
                                            ${analysis.trend}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <hr class="my-2">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                ${analysis.analysis_time}
                            </small>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        网络错误: ${error.message}<br>
                        <small>请检查网络连接后重试</small>
                    </div>
                `;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new SimpleApp();
            
            // 支持回车键分析
            document.getElementById('quickStockCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    runQuickAnalysis();
                }
            });
        });
    </script>
</body>
</html>