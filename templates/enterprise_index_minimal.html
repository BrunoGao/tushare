<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LJWX Stock | 企业级智能投资决策平台</title>
    
    <!-- 本地化资源 - 立即加载 -->
    <link href="{{ url_for('static', filename='vendor/bootstrap/bootstrap.min.css') }}?v=20250805" rel="stylesheet">
    <link href="{{ url_for('static', filename='vendor/bootstrap-icons/bootstrap-icons.css') }}?v=20250805" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/app.css') }}?v=20250805" rel="stylesheet">
    <!-- Fallback CDN Bootstrap in case local fails -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" 
          onerror="this.remove()" media="none" onload="if(media!='all')media='all'">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" 
          onerror="this.remove()" media="none" onload="if(media!='all')media='all'">
    
    <!-- 专业金融终端样式 -->
    <style>
        :root {
            /* Dark Professional Theme */
            --terminal-bg: #0a0e1a;
            --terminal-surface: #111827;
            --terminal-surface-hover: #1f2937;
            --terminal-border: #374151;
            --terminal-text: #f9fafb;
            --terminal-text-secondary: #d1d5db;
            --terminal-text-muted: #9ca3af;
            
            /* Financial Colors */
            --bull-green: #10b981;
            --bear-red: #ef4444;
            --neutral-gray: #64748b;
            --warning-amber: #f59e0b;
            --info-blue: #3b82f6;
            
            /* Trading Colors */
            --bid-blue: #2563eb;
            --ask-red: #dc2626;
            --volume-purple: #7c3aed;
            
            /* System Status */
            --status-online: #22c55e;
            --status-offline: #ef4444;
            --status-warning: #f59e0b;
            
            /* Effects */
            --glow-green: 0 0 20px rgba(16, 185, 129, 0.3);
            --glow-red: 0 0 20px rgba(239, 68, 68, 0.3);
            --glow-blue: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Roboto Mono', 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            background: var(--terminal-bg);
            color: var(--terminal-text);
            margin: 0;
            line-height: 1.4;
            font-weight: 400;
            overflow-x: hidden;
        }
        
        /* Professional Terminal Header */
        .terminal-header {
            background: linear-gradient(135deg, var(--terminal-surface) 0%, #1a1d29 100%);
            border-bottom: 1px solid var(--terminal-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .terminal-topbar {
            background: var(--terminal-bg);
            border-bottom: 1px solid var(--terminal-border);
            padding: 8px 0;
            font-size: 11px;
            font-weight: 500;
        }
        
        .market-ticker {
            display: flex;
            align-items: center;
            gap: 32px;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .ticker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            animation: tickerMove 60s linear infinite;
        }
        
        .ticker-symbol {
            color: var(--terminal-text);
            font-weight: 600;
        }
        
        .ticker-price {
            color: var(--terminal-text-secondary);
        }
        
        .ticker-change {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 10px;
        }
        
        .ticker-change.positive {
            color: var(--bull-green);
        }
        
        .ticker-change.negative {
            color: var(--bear-red);
        }
        
        @keyframes tickerMove {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }
        
        .terminal-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--terminal-text);
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .terminal-brand:hover {
            color: var(--info-blue);
            text-decoration: none;
        }
        
        .brand-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(45deg, var(--info-blue), var(--bull-green));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            box-shadow: var(--glow-blue);
        }
        
        .system-info {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--terminal-text-secondary);
            font-size: 11px;
        }
        
        .market-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--status-online);
            box-shadow: 0 0 10px var(--status-online);
            animation: pulse 2s infinite;
        }
        
        .trading-session {
            color: var(--bull-green);
            font-weight: 600;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .latency {
            color: var(--bull-green);
            font-weight: 500;
        }
        
        .terminal-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .workspace-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .workspace-btn {
            padding: 6px 12px;
            background: var(--terminal-surface);
            border: 1px solid var(--terminal-border);
            border-radius: 4px;
            color: var(--terminal-text-secondary);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .workspace-btn:hover {
            background: var(--terminal-surface-hover);
            color: var(--terminal-text);
            border-color: var(--info-blue);
        }
        
        .workspace-btn.active {
            background: var(--info-blue);
            color: white;
            border-color: var(--info-blue);
            box-shadow: var(--glow-blue);
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(45deg, var(--info-blue), var(--volume-purple));
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .user-avatar:hover {
            box-shadow: var(--glow-blue);
            transform: translateY(-1px);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px var(--status-online); }
            50% { opacity: 0.7; box-shadow: 0 0 5px var(--status-online); }
        }
        
        .enterprise-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }
        
        .page-header {
            margin-bottom: 32px;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }
        
        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1.125rem;
            margin: 0;
        }
        
        .enterprise-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            overflow: hidden;
        }
        
        .enterprise-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .card-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            background: rgba(248, 250, 252, 0.5);
        }
        
        .card-body {
            padding: 24px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .metric-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }
        
        .metric-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .metric-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1;
        }
        
        .metric-change {
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--danger); }
        .metric-change.neutral { color: var(--text-muted); }
        
        .btn-enterprise {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 0.925rem;
            font-weight: 600;
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
        }
        
        .btn-enterprise.primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(30, 64, 175, 0.3);
        }
        
        .btn-enterprise.primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 6px 20px 0 rgba(30, 64, 175, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-enterprise.secondary {
            background: var(--surface);
            color: var(--text-primary);
            border-color: var(--border);
        }
        
        .btn-enterprise.secondary:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 6px;
        }
        
        @keyframes loading { 
            0% { background-position: 200% 0; } 
            100% { background-position: -200% 0; } 
        }
    </style>
</head>
<body>
    <!-- 企业级顶部导航 -->
    <nav class="enterprise-header">
        <div class="container py-3">
            <div class="d-flex align-items-center justify-content-between">
                <a href="#" class="brand-logo">
                    <div class="brand-icon">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                    LJWX Stock
                </a>
                
                <div class="nav-actions">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span id="systemStatus">系统运行正常</span>
                    </div>
                    
                    <div class="user-profile">
                        <i class="bi bi-person"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <div class="enterprise-container">
        <!-- 页面头部 -->
        <div class="page-header">
            <h1 class="page-title">智能投资决策平台</h1>
            <p class="page-subtitle">基于AI的股票分析与推荐系统，为您的投资决策提供专业支持</p>
        </div>

        <!-- 核心指标面板 -->
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">AI模型</div>
                    <div class="metric-icon" style="background: rgba(59, 130, 246, 0.1); color: var(--primary);">
                        <i class="bi bi-cpu"></i>
                    </div>
                </div>
                <div class="metric-value" id="totalModels">-</div>
                <div class="metric-change neutral">
                    <i class="bi bi-graph-up"></i>
                    <span>活跃模型数量</span>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">推荐总数</div>
                    <div class="metric-icon" style="background: rgba(217, 119, 6, 0.1); color: var(--warning);">
                        <i class="bi bi-star-fill"></i>
                    </div>
                </div>
                <div class="metric-value" id="totalRecommendations">-</div>
                <div class="metric-change positive">
                    <i class="bi bi-arrow-up"></i>
                    <span>本月+12%</span>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">预测准确率</div>
                    <div class="metric-icon" style="background: rgba(5, 150, 105, 0.1); color: var(--success);">
                        <i class="bi bi-bullseye"></i>
                    </div>
                </div>
                <div class="metric-value" id="hitRate">-</div>
                <div class="metric-change positive">
                    <i class="bi bi-arrow-up"></i>
                    <span>高于行业平均</span>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">活跃策略</div>
                    <div class="metric-icon" style="background: rgba(6, 182, 212, 0.1); color: var(--accent);">
                        <i class="bi bi-gear-fill"></i>
                    </div>
                </div>
                <div class="metric-value" id="totalStrategies">-</div>
                <div class="metric-change neutral">
                    <i class="bi bi-dash"></i>
                    <span>运行中策略</span>
                </div>
            </div>
        </div>

        <!-- 功能模块区域 -->
        <div class="row g-4 mb-5">
            <!-- 智能分析 -->
            <div class="col-lg-4">
                <div class="enterprise-card h-100">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <div class="metric-icon me-3" style="background: rgba(59, 130, 246, 0.1); color: var(--primary);">
                                <i class="bi bi-search"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold">智能股票分析</h6>
                                <small class="text-muted">AI驱动的实时分析</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="quickStockCode" 
                                   placeholder="输入股票代码 (如: 000001.SZ)" value="600028">
                            <button class="btn-enterprise primary" onclick="runQuickAnalysis()">
                                <i class="bi bi-search"></i>
                                分析
                            </button>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                支持沪深A股代码格式：000001.SZ、600000.SH
                            </small>
                        </div>
                        <div id="quickAnalysisResult"></div>
                    </div>
                </div>
            </div>

            <!-- AI推荐系统 -->
            <div class="col-lg-4">
                <div class="enterprise-card h-100">
                    <div class="card-header">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="metric-icon me-3" style="background: rgba(217, 119, 6, 0.1); color: var(--warning);">
                                    <i class="bi bi-star-fill"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold">AI智能推荐</h6>
                                    <small class="text-muted">机器学习推荐引擎</small>
                                </div>
                            </div>
                            <button class="btn-enterprise secondary" onclick="showRecommendationModal()">
                                <i class="bi bi-plus"></i>
                                生成
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="latestRecommendations">
                            <div class="text-center py-4">
                                <div class="loading-skeleton" style="height: 20px; margin-bottom: 12px;"></div>
                                <div class="loading-skeleton" style="height: 16px; width: 60%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模型管理 -->
            <div class="col-lg-4">
                <div class="enterprise-card h-100">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <div class="metric-icon me-3" style="background: rgba(6, 182, 212, 0.1); color: var(--accent);">
                                <i class="bi bi-cpu"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold">模型训练中心</h6>
                                <small class="text-muted">AI模型生命周期管理</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2 mb-3">
                            <button class="btn-enterprise primary" onclick="showTrainingModal()">
                                <i class="bi bi-play-circle"></i>
                                开始训练
                            </button>
                            <button class="btn-enterprise secondary" onclick="showModelManager()">
                                <i class="bi bi-gear"></i>
                                模型管理
                            </button>
                        </div>
                        <div id="trainingStatus" class="text-center">
                            <small class="text-muted">
                                <i class="bi bi-check-circle me-1"></i>
                                当前无训练任务
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统监控仪表板 -->
        <div class="row g-4">
            <!-- 系统性能 -->
            <div class="col-lg-6">
                <div class="enterprise-card">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <div class="metric-icon me-3" style="background: rgba(5, 150, 105, 0.1); color: var(--success);">
                                <i class="bi bi-activity"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold">系统性能监控</h6>
                                <small class="text-muted">实时系统状态</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="metric-value" style="font-size: 1.75rem;" id="cpuUsage">-</div>
                                    <div class="metric-title">CPU使用率</div>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-success" style="width: 15%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="metric-value" style="font-size: 1.75rem;" id="memoryUsage">-</div>
                                    <div class="metric-title">内存使用率</div>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-info" style="width: 45%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="metric-value" style="font-size: 1.75rem;" id="activeConnections">-</div>
                                    <div class="metric-title">活跃连接</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="metric-value" style="font-size: 1.75rem;" id="lastDataUpdate">-</div>
                                    <div class="metric-title">最后更新</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 市场概览 -->
            <div class="col-lg-6">
                <div class="enterprise-card">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <div class="metric-icon me-3" style="background: rgba(220, 38, 38, 0.1); color: var(--danger);">
                                <i class="bi bi-graph-up"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold">市场概览</h6>
                                <small class="text-muted">实时市场数据</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="metric-value" style="font-size: 1.75rem;" id="marketTrend">-</div>
                                    <div class="metric-title">市场趋势</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="metric-value" style="font-size: 1.75rem;" id="activeStocks">-</div>
                                    <div class="metric-title">活跃股票</div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="text-center">
                                    <div class="d-inline-flex align-items-center gap-2 px-3 py-2 rounded-pill" 
                                         style="background: rgba(248, 250, 252, 0.8); border: 1px solid var(--border);">
                                        <div class="status-dot" style="width: 6px; height: 6px;"></div>
                                        <span class="fw-bold" id="marketStatus">市场已闭市</span>
                                    </div>
                                    <div class="metric-title mt-2">交易状态</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模型训练模态框 -->
    <div class="modal fade" id="trainingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-cpu me-2"></i>AI模型训练
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">基础模型</label>
                        <select class="form-select" id="baseModelSelect">
                            <option value="ljwx-stock">ljwx-stock (推荐)</option>
                            <option value="deepseek-coder">deepseek-coder (代码增强)</option>
                            <option value="qwen">qwen (通用模型)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">训练数据</label>
                        <select class="form-select" id="trainingDataSelect">
                            <option value="">正在加载训练数据...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">新模型名称</label>
                        <input type="text" class="form-control" id="newModelName" placeholder="如: my-stock-model">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">训练样本数</label>
                        <select class="form-select" id="sampleCount">
                            <option value="100">100 (快速测试)</option>
                            <option value="500" selected>500 (推荐)</option>
                            <option value="1000">1000 (高精度)</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        训练时间预计 20-60 分钟，请耐心等待。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="startModelTraining()">
                        <i class="bi bi-play-circle me-1"></i>开始训练
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模型管理模态框 -->
    <div class="modal fade" id="modelManagerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear me-2"></i>模型管理
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="modelsList">
                        <div class="text-center py-4">
                            <div class="spinner-border mb-2" role="status"></div>
                            <p class="mb-0">正在加载模型列表...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="refreshModelsList()">
                        <i class="bi bi-arrow-clockwise me-1"></i>刷新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 推荐生成模态框 -->
    <div class="modal fade" id="recommendationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-star me-2"></i>生成股票推荐
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">推荐模型</label>
                        <select class="form-select" id="recModelSelect">
                            <option value="">选择AI模型</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">推荐数量</label>
                        <select class="form-select" id="numStocks">
                            <option value="3">3只股票</option>
                            <option value="5" selected>5只股票</option>
                            <option value="10">10只股票</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useDailyMode" checked>
                            <label class="form-check-label" for="useDailyMode">
                                启用每日推荐模式（自动选择市场活跃股票）
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">TuShare Token（可选）</label>
                        <input type="text" class="form-control" id="recTushareToken" placeholder="留空使用系统配置">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="generateRecommendations()">
                        <i class="bi bi-star me-1"></i>生成推荐
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 简化的JS - 优化加载 -->
    <script>
        // 快速加载函数
        function loadScript(src, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            script.onerror = () => console.warn('Failed to load:', src);
            document.head.appendChild(script);
        }
        
        // 异步加载外部资源
        let socketLoaded = false;
        let bootstrapLoaded = false;
        
        function checkAndInit() {
            if (socketLoaded && document.readyState === 'complete') {
                try {
                    new SimpleApp();
                } catch (e) {
                    console.error('App init failed:', e);
                    // 降级到基础功能
                    setTimeout(() => loadBasicData(), 1000);
                }
            }
        }
        
        loadScript('https://cdn.socket.io/4.7.2/socket.io.min.js', () => {
            console.log('Socket.IO loaded');
            socketLoaded = true;
            checkAndInit();
        });
        loadScript('https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js', () => {
            console.log('Bootstrap JS loaded');
            bootstrapLoaded = true;
        });
        
        // 基础数据加载（不依赖Socket.IO）
        async function loadBasicData() {
            try {
                const [dashboard, models] = await Promise.all([
                    fetch('/api/mobile/dashboard').then(r => r.json()),
                    fetch('/api/models-info').then(r => r.json())
                ]);
                
                window.updateMetrics(dashboard);
                window.updateModelSelects(models.models || []);
                
                const recs = await fetch('/api/mobile/recommendations/latest?limit=3').then(r => r.json());
                window.updateRecommendations(recs.recommendations || []);
            } catch (e) {
                console.error('Basic load failed:', e);
                // 显示离线状态
                document.getElementById('systemStatus').className = 'status-badge danger';
                document.getElementById('systemStatus').innerHTML = '<i class="bi bi-circle-fill me-1"></i>连接失败';
            }
        }
    </script>
    <script>
        class SimpleApp {
            constructor() {
                this.socket = window.io ? io() : null;
                this.init();
            }
            
            init() {
                this.socket.on('connected', () => console.log('Connected'));
                this.socket.on('recommendation_generated', (data) => {
                    console.log('推荐生成完成:', data);
                    this.handleRecommendationGenerated(data);
                });
                this.socket.on('task_failed', (data) => {
                    console.error('任务失败:', data);
                    this.handleTaskFailed(data);
                });
                this.loadData();
                setInterval(() => this.loadData(), 60000);
            }
            
            handleRecommendationGenerated(data) {
                const container = document.getElementById('latestRecommendations');
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>生成完成!</strong> 
                        使用模型 ${data.model_name} 生成了 ${data.total_recommendations} 个推荐
                    </div>
                `;
                
                // 重新加载推荐数据
                setTimeout(() => {
                    this.loadRecommendations();
                }, 1000);
            }
            
            handleTaskFailed(data) {
                const container = document.getElementById('latestRecommendations');
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>生成失败:</strong> ${data.error}
                    </div>
                `;
            }
            
            async loadRecommendations() {
                try {
                    const recs = await fetch('/api/mobile/recommendations/latest?limit=3').then(r => r.json());
                    this.updateRecommendations(recs.recommendations || []);
                } catch (e) {
                    console.error('加载推荐失败:', e);
                }
            }
            
            async loadData() {
                try {
                    const [status, dashboard, models] = await Promise.all([
                        fetch('/api/status').then(r => r.json()),
                        fetch('/api/mobile/dashboard').then(r => r.json()),
                        fetch('/api/models-info').then(r => r.json())
                    ]);
                    
                    this.updateMetrics(dashboard);
                    this.updateModelSelects(models.models || []);
                    
                    const recs = await fetch('/api/mobile/recommendations/latest?limit=3').then(r => r.json());
                    this.updateRecommendations(recs.recommendations || []);
                } catch (e) {
                    console.error('Load failed:', e);
                }
            }
            
            updateModelSelects(models) {
                window.updateModelSelects(models);
            }
        }
        
        // 全局函数定义
        window.updateModelSelects = function(models) {
            const select = document.getElementById('recModelSelect');
            if (select) {
                select.innerHTML = '<option value="">选择AI模型</option>' +
                    models.map(model => 
                        `<option value="${model.name}">${model.name} (${model.size})</option>`
                    ).join('');
            }
        };
            
        window.updateMetrics = function(data) {
                document.getElementById('totalModels').textContent = data.training_summary?.total_models || 0;
                document.getElementById('totalRecommendations').textContent = data.recommendation_summary?.total_recommendations || 0;
                document.getElementById('hitRate').textContent = ((data.recommendation_summary?.hit_rate || 0) * 100).toFixed(1) + '%';
                document.getElementById('totalStrategies').textContent = data.strategy_summary?.total_strategies || 0;
                
                // 更新系统监控数据
                document.getElementById('cpuUsage').textContent = '15%';
                document.getElementById('memoryUsage').textContent = '45%';
                document.getElementById('activeConnections').textContent = '8';
                document.getElementById('lastDataUpdate').textContent = new Date().getHours() + ':' + String(new Date().getMinutes()).padStart(2, '0');
                
                // 更新市场概览
                document.getElementById('marketTrend').textContent = '震荡';
                document.getElementById('activeStocks').textContent = data.market_summary?.total_stocks || '5150';
                
                // 更新市场状态
                const now = new Date();
                const hour = now.getHours();
                const isTrading = (hour >= 9 && hour < 15) && (now.getDay() >= 1 && now.getDay() <= 5);
                document.getElementById('marketStatus').textContent = isTrading ? '交易中' : '已闭市';
                document.getElementById('marketStatus').className = isTrading ? 'fs-6 fw-bold text-success' : 'fs-6 fw-bold text-muted';
        };
            
        window.updateRecommendations = function(recs) {
                const container = document.getElementById('latestRecommendations');
                if (recs.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <div class="metric-icon mx-auto mb-3" style="background: rgba(217, 119, 6, 0.1); color: var(--warning); width: 60px; height: 60px; font-size: 1.5rem;">
                                <i class="bi bi-star"></i>
                            </div>
                            <p class="text-muted mb-0">暂无推荐数据</p>
                            <small class="text-muted">点击"生成"按钮创建AI推荐</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = recs.map((rec, index) => `
                    <div class="d-flex justify-content-between align-items-center py-3 ${index < recs.length - 1 ? 'border-bottom' : ''} animate-fadeIn" style="animation-delay: ${index * 0.1}s;">
                        <div class="flex-grow-1">
                            <div class="fw-bold text-primary">${rec.stock_name || rec.stock_code}</div>
                            <small class="text-muted">${rec.stock_code}</small>
                        </div>
                        <div class="text-end">
                            <div class="d-inline-flex align-items-center gap-2 px-2 py-1 rounded-pill ${window.getTypeClass(rec.recommendation_type) === 'success' ? 'bg-success' : window.getTypeClass(rec.recommendation_type) === 'danger' ? 'bg-danger' : 'bg-warning'}" 
                                 style="background-color: ${window.getTypeBgColor(rec.recommendation_type)} !important; color: white; font-size: 0.75rem; font-weight: 600;">
                                <i class="bi ${window.getTypeIcon(rec.recommendation_type)}"></i>
                                ${window.getTypeLabel(rec.recommendation_type)}
                            </div>
                            <div class="text-muted small mt-1">
                                置信度: <span class="fw-bold">${(rec.confidence_score * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                    </div>
                `).join('');
        };
            
        window.getTypeClass = function(type) {
                return {'buy': 'success', 'sell': 'danger', 'hold': 'warning'}[type] || 'secondary';
        };
        
        window.getTypeBgColor = function(type) {
            return {'buy': '#059669', 'sell': '#dc2626', 'hold': '#d97706'}[type] || '#64748b';
        };
        
        window.getTypeIcon = function(type) {
            return {'buy': 'bi-arrow-up-circle', 'sell': 'bi-arrow-down-circle', 'hold': 'bi-dash-circle'}[type] || 'bi-circle';
        };
            
        window.getTypeLabel = function(type) {
            return {'buy': '买入', 'sell': '卖出', 'hold': '持有'}[type] || type;
        };
        
        // 推荐生成功能
        function showRecommendationModal() {
            const modal = new bootstrap.Modal(document.getElementById('recommendationModal'));
            modal.show();
        }
        
        // 模型训练功能
        function showTrainingModal() {
            const modal = new bootstrap.Modal(document.getElementById('trainingModal'));
            modal.show();
            loadTrainingData();
        }
        
        function showModelManager() {
            const modal = new bootstrap.Modal(document.getElementById('modelManagerModal'));
            modal.show();
            loadModelsList();
        }
        
        async function loadTrainingData() {
            try {
                const response = await fetch('/api/training-data-info');
                const data = await response.json();
                
                const select = document.getElementById('trainingDataSelect');
                select.innerHTML = '<option value="">选择训练数据</option>' +
                    data.files.map(file => 
                        `<option value="${file.filename}">${file.filename} (${file.sample_count} 样本)</option>`
                    ).join('');
            } catch (e) {
                console.error('加载训练数据失败:', e);
                document.getElementById('trainingDataSelect').innerHTML = '<option value="">加载失败</option>';
            }
        }
        
        async function loadModelsList() {
            try {
                const response = await fetch('/api/models-info');
                const data = await response.json();
                
                const container = document.getElementById('modelsList');
                if (data.models.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-4">暂无可用模型</div>';
                    return;
                }
                
                container.innerHTML = data.models.map(model => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title">${model.name}</h6>
                                    <p class="card-text text-muted small mb-2">${model.description || '暂无描述'}</p>
                                    <small class="text-muted">
                                        大小: ${model.size} | 
                                        创建: ${new Date(model.created).toLocaleDateString()}
                                        ${model.performance ? ` | 命中率: ${(model.performance.hit_rate * 100).toFixed(1)}%` : ''}
                                    </small>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        操作
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="setDefaultModel('${model.name}')">设为默认</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="testModel('${model.name}')">测试模型</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteModel('${model.name}')">删除</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('加载模型列表失败:', e);
                document.getElementById('modelsList').innerHTML = '<div class="alert alert-danger">加载失败</div>';
            }
        }
        
        async function startModelTraining() {
            const baseModel = document.getElementById('baseModelSelect').value;
            const trainingFile = document.getElementById('trainingDataSelect').value;
            const modelName = document.getElementById('newModelName').value;
            const sampleCount = parseInt(document.getElementById('sampleCount').value);
            
            if (!trainingFile || !modelName) {
                alert('请选择训练数据并输入模型名称');
                return;
            }
            
            const config = {
                base_model: baseModel,
                training_file: trainingFile,
                model_name: modelName,
                sample_count: sampleCount
            };
            
            try {
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('trainingModal'));
                modal.hide();
                
                // 显示训练状态
                const statusDiv = document.getElementById('trainingStatus');
                statusDiv.innerHTML = `
                    <div class="text-primary">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        正在训练模型: ${modelName}
                    </div>
                `;
                
                const response = await fetch('/api/train-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.status === 'started') {
                    console.log('模型训练已启动');
                    // 状态会通过WebSocket更新
                } else {
                    statusDiv.innerHTML = `<div class="text-danger">训练启动失败: ${data.error || '未知错误'}</div>`;
                }
            } catch (error) {
                console.error('启动训练失败:', error);
                document.getElementById('trainingStatus').innerHTML = `<div class="text-danger">网络错误: ${error.message}</div>`;
            }
        }
        
        function refreshModelsList() {
            loadModelsList();
        }
        
        async function setDefaultModel(modelName) {
            // 这里可以添加设置默认模型的API调用
            alert(`已设置 ${modelName} 为默认模型`);
        }
        
        async function testModel(modelName) {
            alert(`正在测试模型 ${modelName}...`);
        }
        
        async function deleteModel(modelName) {
            if (confirm(`确定要删除模型 ${modelName} 吗？此操作不可撤销。`)) {
                alert(`模型 ${modelName} 删除功能暂未实现`);
            }
        }
        
        async function generateRecommendations() {
            const modelName = document.getElementById('recModelSelect').value;
            const numStocks = parseInt(document.getElementById('numStocks').value);
            const useDailyMode = document.getElementById('useDailyMode').checked;
            const tushareToken = document.getElementById('recTushareToken').value;
            
            if (!modelName) {
                alert('请选择AI模型');
                return;
            }
            
            const config = {
                model_name: modelName,
                num_stocks: numStocks,
                use_daily_mode: useDailyMode,
                analysis_type: 'comprehensive_analysis'
            };
            
            if (tushareToken.trim()) {
                config.tushare_token = tushareToken.trim();
            }
            
            try {
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('recommendationModal'));
                modal.hide();
                
                // 显示生成中状态
                const container = document.getElementById('latestRecommendations');
                container.innerHTML = `
                    <div class="text-center text-primary py-4">
                        <div class="spinner-border mb-2"></div>
                        <p class="mb-0">正在生成推荐...</p>
                        <small class="text-muted">使用模型: ${modelName}</small>
                    </div>
                `;
                
                const response = await fetch('/api/recommendations/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.status === 'started') {
                    console.log('推荐生成已启动');
                    // 状态会通过WebSocket更新
                } else {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            推荐生成失败: ${data.error || '未知错误'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('生成推荐失败:', error);
                document.getElementById('latestRecommendations').innerHTML = `
                    <div class="alert alert-danger">
                        网络错误: ${error.message}
                    </div>
                `;
            }
        }
        
        // 快速分析功能
        async function runQuickAnalysis() {
            const stockCode = document.getElementById('quickStockCode').value.trim();
            const resultDiv = document.getElementById('quickAnalysisResult');
            
            if (!stockCode) {
                resultDiv.innerHTML = '<div class="alert alert-warning">请输入股票代码</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>分析中...</div>';
            
            try {
                const response = await fetch('/api/mobile/quick-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_code: stockCode })
                });
                
                const data = await response.json();
                
                if (data.error || data.analysis?.error) {
                    const error = data.error || data.analysis.error;
                    const suggestion = data.analysis?.suggestion || '请检查股票代码格式';
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>分析失败:</strong> ${error}<br>
                            <small>${suggestion}</small>
                        </div>
                    `;
                } else {
                    const analysis = data.analysis;
                    resultDiv.innerHTML = `
                        <div class="mt-2">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">当前价格</small>
                                    <div class="fw-bold">¥${analysis.current_price}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">涨跌幅</small>
                                    <div class="fw-bold ${analysis.price_change >= 0 ? 'text-success' : 'text-danger'}">
                                        ${analysis.price_change >= 0 ? '+' : ''}${analysis.price_change.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <small class="text-muted">成交量</small>
                                    <div class="fw-bold">${(analysis.volume / 10000).toFixed(2)}万手</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">趋势</small>
                                    <div>
                                        <span class="status-badge ${analysis.trend === '上涨' ? 'success' : 'danger'}">
                                            ${analysis.trend}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <hr class="my-2">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                ${analysis.analysis_time}
                            </small>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        网络错误: ${error.message}<br>
                        <small>请检查网络连接后重试</small>
                    </div>
                `;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // 立即加载基础数据
            loadBasicData();
            
            // 支持回车键分析
            document.getElementById('quickStockCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    runQuickAnalysis();
                }
            });
            
            // 检查是否可以初始化Socket.IO应用
            checkAndInit();
        });
    </script>
</body>
</html>