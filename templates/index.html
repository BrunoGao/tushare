{% extends "base.html" %}

{% block content %}
<div x-data="dashboardApp()" x-cloak>
    <!-- 页面头部 -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 sm:text-4xl">股票分析系统</h1>
        <p class="mt-2 text-gray-600">实时数据分析与智能推荐</p>
    </div>
    
    <!-- 快速搜索 -->
    <div class="mb-8">
        <div class="relative max-w-md mx-auto sm:max-w-lg">
            <input 
                type="text" 
                x-model="searchQuery"
                @input="searchStocks"
                placeholder="搜索股票代码或名称..."
                class="w-full px-4 py-3 pl-12 pr-4 text-gray-900 placeholder-gray-500 bg-white border border-gray-300 rounded-xl shadow-sm focus:border-purple-500 focus:ring-purple-500 focus:outline-none"
            >
            <div class="absolute inset-y-0 left-0 flex items-center pl-4">
                <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
            </div>
            
            <!-- 搜索结果下拉 -->
            <div x-show="searchResults.length > 0" 
                 class="absolute top-full mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg z-10">
                <template x-for="stock in searchResults" :key="stock.ts_code">
                    <div @click="selectStock(stock)" 
                         class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                        <div class="font-medium text-gray-900" x-text="stock.display_name"></div>
                        <div class="text-sm text-gray-500">
                            <span x-text="stock.ts_code"></span> | 
                            <span x-text="stock.industry"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    <!-- 功能卡片网格 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- 技术分析卡片 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center mb-4">
                <div class="p-3 bg-blue-100 rounded-lg">
                    <i data-lucide="bar-chart-3" class="h-6 w-6 text-blue-600"></i>
                </div>
                <h3 class="ml-3 text-lg font-semibold text-gray-900">技术分析</h3>
            </div>
            <p class="text-gray-600 text-sm mb-4">专业的技术指标分析和图表展示</p>
            <button @click="openAnalysis()" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                开始分析
            </button>
        </div>
        
        <!-- 智能推荐卡片 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center mb-4">
                <div class="p-3 bg-green-100 rounded-lg">
                    <i data-lucide="target" class="h-6 w-6 text-green-600"></i>
                </div>
                <h3 class="ml-3 text-lg font-semibold text-gray-900">智能推荐</h3>
            </div>
            <p class="text-gray-600 text-sm mb-4">AI驱动的股票推荐和策略建议</p>
            <button @click="getRecommendations()" 
                    class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                获取推荐
            </button>
        </div>
        
        <!-- 实时监控卡片 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center mb-4">
                <div class="p-3 bg-purple-100 rounded-lg">
                    <i data-lucide="activity" class="h-6 w-6 text-purple-600"></i>
                </div>
                <h3 class="ml-3 text-lg font-semibold text-gray-900">实时监控</h3>
            </div>
            <p class="text-gray-600 text-sm mb-4">实时价格变动和信号提醒</p>
            <button @click="openMonitoring()" 
                    class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                开启监控
            </button>
        </div>
        
        <!-- AI分析卡片 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center mb-4">
                <div class="p-3 bg-orange-100 rounded-lg">
                    <i data-lucide="brain" class="h-6 w-6 text-orange-600"></i>
                </div>
                <h3 class="ml-3 text-lg font-semibold text-gray-900">AI分析</h3>
            </div>
            <p class="text-gray-600 text-sm mb-4">深度学习模型预测和分析</p>
            <button @click="openAIAnalysis()" 
                    class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">
                AI分析
            </button>
        </div>
    </div>
    
    <!-- 热门股票 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900">热门股票</h2>
            <button @click="refreshHotStocks()" class="text-purple-600 hover:text-purple-700">
                <i data-lucide="refresh-cw" class="h-5 w-5"></i>
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200 text-left text-sm font-medium text-gray-500">
                        <th class="pb-3">股票</th>
                        <th class="pb-3 text-right">现价</th>
                        <th class="pb-3 text-right">涨跌</th>
                        <th class="pb-3 text-right">涨跌幅</th>
                        <th class="pb-3 text-right">成交量</th>
                        <th class="pb-3 text-center">操作</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    <template x-for="stock in hotStocks" :key="stock.ts_code">
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-4">
                                <div>
                                    <div class="font-medium text-gray-900" x-text="stock.name"></div>
                                    <div class="text-gray-500" x-text="stock.ts_code"></div>
                                </div>
                            </td>
                            <td class="py-4 text-right font-medium" x-text="formatNumber(stock.close)"></td>
                            <td class="py-4 text-right" :class="stock.change >= 0 ? 'text-bull' : 'text-bear'" 
                                x-text="stock.change >= 0 ? '+' + formatNumber(stock.change) : formatNumber(stock.change)"></td>
                            <td class="py-4 text-right" :class="stock.pct_chg >= 0 ? 'text-bull' : 'text-bear'" 
                                x-text="formatPercent(stock.pct_chg)"></td>
                            <td class="py-4 text-right text-gray-600" x-text="formatNumber(stock.vol/10000, 0) + '万'"></td>
                            <td class="py-4 text-center">
                                <button @click="viewStock(stock.ts_code)" 
                                        class="text-purple-600 hover:text-purple-700 text-sm">
                                    查看
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 市场概览 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- 指数行情 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">主要指数</h2>
            <div class="space-y-4">
                <template x-for="index in majorIndexes" :key="index.code">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900" x-text="index.name"></div>
                            <div class="text-sm text-gray-500" x-text="index.code"></div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium" x-text="formatNumber(index.close)"></div>
                            <div :class="index.pct_chg >= 0 ? 'text-bull' : 'text-bear'" 
                                 x-text="formatPercent(index.pct_chg)"></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- 系统状态 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">系统状态</h2>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">数据更新时间</span>
                    <span class="font-medium" x-text="lastUpdateTime"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">WebSocket连接</span>
                    <span :class="wsConnected ? 'text-green-600' : 'text-red-600'" 
                          x-text="wsConnected ? '已连接' : '未连接'"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">监控股票数</span>
                    <span class="font-medium" x-text="monitoredStocks"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">今日信号数</span>
                    <span class="font-medium" x-text="todaySignals"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function dashboardApp() {
    return {
        searchQuery: '',
        searchResults: [],
        hotStocks: [],
        majorIndexes: [],
        lastUpdateTime: '--',
        wsConnected: false,
        monitoredStocks: 0,
        todaySignals: 0,
        
        init() {
            this.loadHotStocks();
            this.loadMajorIndexes();
            this.connectWebSocket();
            this.updateSystemStatus();
        },
        
        async searchStocks() {
            if (this.searchQuery.length < 2) {
                this.searchResults = [];
                return;
            }
            
            try {
                const response = await apiRequest(`/api/stocks/search?q=${encodeURIComponent(this.searchQuery)}&limit=5`);
                this.searchResults = response.data || [];
            } catch (error) {
                this.searchResults = [];
            }
        },
        
        selectStock(stock) {
            this.searchQuery = stock.display_name;
            this.searchResults = [];
            this.viewStock(stock.ts_code);
        },
        
        async loadHotStocks() {
            try {
                const response = await apiRequest('/api/stocks/hot?limit=10');
                this.hotStocks = response.data || [];
            } catch (error) {
                console.error('加载热门股票失败:', error);
            }
        },
        
        async loadMajorIndexes() {
            try {
                const response = await apiRequest('/api/indexes/major');
                this.majorIndexes = response.data || [];
            } catch (error) {
                console.error('加载指数数据失败:', error);
            }
        },
        
        connectWebSocket() {
            try {
                const ws = new WebSocket(`ws://${window.location.hostname}:8765`);
                
                ws.onopen = () => {
                    this.wsConnected = true;
                    console.log('WebSocket连接成功');
                };
                
                ws.onclose = () => {
                    this.wsConnected = false;
                    console.log('WebSocket连接断开');
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    this.wsConnected = false;
                };
            } catch (error) {
                console.error('WebSocket连接失败:', error);
            }
        },
        
        handleWebSocketMessage(data) {
            if (data.type === 'realtime_update') {
                // 处理实时数据更新
                this.updateStockPrice(data.code, data.data);
            }
        },
        
        updateStockPrice(code, data) {
            // 更新热门股票列表中的价格
            const stock = this.hotStocks.find(s => s.ts_code === code);
            if (stock && data.price) {
                stock.close = data.price.current;
                stock.change = data.price.change;
                stock.pct_chg = data.price.change_pct;
            }
        },
        
        async updateSystemStatus() {
            try {
                const response = await apiRequest('/api/system/status');
                const status = response.data || {};
                
                this.lastUpdateTime = status.last_update || '--';
                this.monitoredStocks = status.monitored_stocks || 0;
                this.todaySignals = status.today_signals || 0;
            } catch (error) {
                console.error('获取系统状态失败:', error);
            }
        },
        
        openAnalysis() {
            window.location.href = '/analysis';
        },
        
        async getRecommendations() {
            try {
                showToast('正在获取推荐...', 'info');
                const response = await apiRequest('/api/recommendations');
                if (response.success) {
                    showToast('推荐获取成功!');
                    // 可以打开推荐页面或显示模态框
                    window.location.href = '/recommendations';
                }
            } catch (error) {
                showToast('获取推荐失败', 'error');
            }
        },
        
        openMonitoring() {
            window.location.href = '/signals';
        },
        
        openAIAnalysis() {
            window.location.href = '/ai-analysis';
        },
        
        viewStock(tsCode) {
            window.location.href = `/analysis?code=${tsCode}`;
        },
        
        refreshHotStocks() {
            this.loadHotStocks();
            showToast('数据已刷新');
        }
    }
}
</script>
{% endblock %}