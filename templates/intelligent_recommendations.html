{% extends "base.html" %}

{% block title %}æ™ºèƒ½æ¨è - çµå¢ƒä¸‡è±¡{% endblock %}

{% block content %}
<div x-data="intelligentRecommendationsApp()" x-cloak>
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">ğŸ¤– æ™ºèƒ½æ¨è</h1>
        <p class="mt-1 text-gray-600">åŸºäºAIå¤§æ¨¡å‹çš„è‚¡ç¥¨æ™ºèƒ½åˆ†ææ¨èç³»ç»Ÿ</p>
    </div>
    
    <!-- ç³»ç»ŸçŠ¶æ€é¢æ¿ -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-2 sm:mb-0">ç³»ç»ŸçŠ¶æ€</h2>
            <button @click="checkSystemHealth()" 
                    :disabled="isLoadingHealth"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                <span x-show="!isLoadingHealth">æ£€æŸ¥çŠ¶æ€</span>
                <span x-show="isLoadingHealth" class="flex items-center">
                    <i data-lucide="loader" class="animate-spin h-4 w-4 mr-2"></i>
                    æ£€æŸ¥ä¸­...
                </span>
            </button>
        </div>
        
        <div x-show="systemHealth" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold" 
                     :class="systemHealth?.overall_status === 'healthy' ? 'text-green-600' : systemHealth?.overall_status === 'error' ? 'text-red-600' : 'text-yellow-600'"
                     x-text="systemHealth?.overall_status === 'healthy' ? 'ğŸŸ¢ å¥åº·' : systemHealth?.overall_status === 'error' ? 'ğŸ”´ å¼‚å¸¸' : 'ğŸŸ¡ è­¦å‘Š'"></div>
                <div class="text-sm text-gray-500">ç³»ç»ŸçŠ¶æ€</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-blue-600" 
                     x-text="systemHealth?.components?.ollama?.status === 'healthy' ? 'ğŸŸ¢ æ­£å¸¸' : 'ğŸ”´ å¼‚å¸¸'"></div>
                <div class="text-sm text-gray-500">OllamaæœåŠ¡</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-green-600" 
                     x-text="formatNumber(systemHealth?.components?.database?.stock_count || 0)"></div>
                <div class="text-sm text-gray-500">è‚¡ç¥¨æ•°æ®</div>
            </div>
        </div>
    </div>
    
    <!-- æ¨èç”Ÿæˆé¢æ¿ -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">æ¨èè®¾ç½®</label>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">æœ€å¤§è‚¡ç¥¨æ•°</label>
                        <select x-model="generateSettings.maxStocks" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            <option value="10">10åª</option>
                            <option value="20">20åª</option>
                            <option value="30">30åª</option>
                            <option value="50">50åª</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">å¹¶å‘æ•°</label>
                        <select x-model="generateSettings.maxConcurrent" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            <option value="3">3</option>
                            <option value="5">5</option>
                            <option value="8">8</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="flex items-end">
                <button @click="generateRecommendations()" 
                        :disabled="isGenerating"
                        class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span x-show="!isGenerating">ğŸš€ ç”Ÿæˆæ¨è</span>
                    <span x-show="isGenerating" class="flex items-center justify-center">
                        <i data-lucide="loader" class="animate-spin h-4 w-4 mr-2"></i>
                        ç”Ÿæˆä¸­...
                    </span>
                </button>
            </div>
            
            <div class="flex items-end">
                <button @click="loadLatestRecommendations()" 
                        :disabled="isLoading"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span x-show="!isLoading">ğŸ“Š åŠ è½½æœ€æ–°</span>
                    <span x-show="isLoading" class="flex items-center justify-center">
                        <i data-lucide="loader" class="animate-spin h-4 w-4 mr-2"></i>
                        åŠ è½½ä¸­...
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ç”Ÿæˆè¿›åº¦ -->
    <div x-show="generationInfo" class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
        <h3 class="text-lg font-semibold text-blue-900 mb-2">ğŸ“ˆ ç”Ÿæˆç»Ÿè®¡</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
                <span class="text-blue-700">æ€»æ•°é‡: </span>
                <span class="font-bold" x-text="generationInfo?.count || 0"></span>
            </div>
            <div>
                <span class="text-green-700">ä¹°å…¥: </span>
                <span class="font-bold text-green-600" x-text="generationInfo?.buy_count || 0"></span>
            </div>
            <div>
                <span class="text-yellow-700">æŒæœ‰: </span>
                <span class="font-bold text-yellow-600" x-text="generationInfo?.hold_count || 0"></span>
            </div>
            <div>
                <span class="text-blue-700">å¹³å‡ç½®ä¿¡åº¦: </span>
                <span class="font-bold" x-text="(generationInfo?.avg_confidence || 0).toFixed(3)"></span>
            </div>
        </div>
    </div>
    
    <!-- æ¨èç»“æœåˆ—è¡¨ -->
    <div x-show="recommendations.length > 0" class="space-y-4">
        <h2 class="text-xl font-semibold text-gray-900">ğŸ¯ æ¨èç»“æœ</h2>
        
        <!-- è¿‡æ»¤å™¨ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="flex flex-wrap gap-3">
                <select x-model="filters.recommendation" @change="filterRecommendations()" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">å…¨éƒ¨æ¨è</option>
                    <option value="buy">ä¹°å…¥</option>
                    <option value="hold">æŒæœ‰</option>
                    <option value="sell">å–å‡º</option>
                </select>
                
                <select x-model="filters.riskLevel" @change="filterRecommendations()" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">å…¨éƒ¨é£é™©</option>
                    <option value="low">ä½é£é™©</option>
                    <option value="medium">ä¸­é£é™©</option>
                    <option value="high">é«˜é£é™©</option>
                </select>
                
                <select x-model="filters.marketPosition" @change="filterRecommendations()" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">å…¨éƒ¨ç±»å‹</option>
                    <option value="é¾™å¤´">é¾™å¤´è‚¡</option>
                    <option value="æˆé•¿">æˆé•¿è‚¡</option>
                    <option value="ä»·å€¼">ä»·å€¼è‚¡</option>
                    <option value="å°ç›˜">å°ç›˜è‚¡</option>
                </select>
                
                <input type="text" x-model="filters.search" @input="filterRecommendations()" 
                       placeholder="æœç´¢è‚¡ç¥¨åç§°æˆ–ä»£ç ..." 
                       class="px-3 py-2 border border-gray-300 rounded-lg flex-1 min-w-48">
            </div>
        </div>
        
        <!-- æ¨èå¡ç‰‡ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <template x-for="(rec, index) in filteredRecommendations" :key="rec.ts_code">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <!-- å¤´éƒ¨ -->
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900" x-text="rec.name"></h3>
                                <p class="text-sm text-gray-500" x-text="rec.ts_code + ' | ' + rec.sector"></p>
                            </div>
                            <div class="text-right">
                                <div class="px-3 py-1 rounded-full text-sm font-medium"
                                     :class="getRecommendationBadgeClass(rec.recommendation)"
                                     x-text="getRecommendationText(rec.recommendation)"></div>
                                <div class="text-xs text-gray-500 mt-1" x-text="rec.market_position"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
                    <div class="p-4">
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-lg font-bold text-purple-600" x-text="rec.confidence.toFixed(3)"></div>
                                <div class="text-xs text-gray-500">ç½®ä¿¡åº¦</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-blue-600" x-text="rec.technical_score.toFixed(3)"></div>
                                <div class="text-xs text-gray-500">æŠ€æœ¯åˆ†æ</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-green-600" x-text="rec.ai_score.toFixed(3)"></div>
                                <div class="text-xs text-gray-500">AIåˆ†æ</div>
                            </div>
                        </div>
                        
                        <!-- ä»·æ ¼ä¿¡æ¯ -->
                        <div class="grid grid-cols-2 gap-4 mb-4" x-show="rec.target_price || rec.stop_loss">
                            <div x-show="rec.target_price">
                                <div class="text-sm text-gray-500">ç›®æ ‡ä»·</div>
                                <div class="text-lg font-semibold text-green-600" x-text="'Â¥' + rec.target_price.toFixed(2)"></div>
                            </div>
                            <div x-show="rec.stop_loss">
                                <div class="text-sm text-gray-500">æ­¢æŸä»·</div>
                                <div class="text-lg font-semibold text-red-600" x-text="'Â¥' + rec.stop_loss.toFixed(2)"></div>
                            </div>
                        </div>
                        
                        <!-- é£é™©å’ŒæŒæœ‰æœŸ -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-500">é£é™©ç­‰çº§:</span>
                                <span class="px-2 py-1 rounded text-xs font-medium"
                                      :class="getRiskLevelClass(rec.risk_level)"
                                      x-text="rec.risk_level"></span>
                            </div>
                            <div class="text-xs text-gray-500" x-text="rec.holding_period"></div>
                        </div>
                        
                        <!-- å…³é”®å› ç´  -->
                        <div class="mb-4" x-show="rec.key_factors && rec.key_factors.length > 0">
                            <div class="text-sm font-medium text-gray-700 mb-2">å…³é”®å› ç´ </div>
                            <div class="flex flex-wrap gap-1">
                                <template x-for="factor in rec.key_factors.slice(0, 3)" :key="factor">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded" x-text="factor"></span>
                                </template>
                            </div>
                        </div>
                        
                        <!-- åˆ†ææ¨ç† -->
                        <div class="mb-4">
                            <div class="text-sm font-medium text-gray-700 mb-2">åˆ†ææ¨ç†</div>
                            <p class="text-sm text-gray-600 line-clamp-3" x-text="rec.reasoning"></p>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="flex space-x-2">
                            <button @click="viewStockDetail(rec.ts_code)" 
                                    class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                            <button @click="addToWatchlist(rec.ts_code)" 
                                    class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">
                                <i data-lucide="bookmark" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- æ— ç»“æœæç¤º -->
        <div x-show="filteredRecommendations.length === 0" class="text-center py-12">
            <i data-lucide="search" class="h-12 w-12 mx-auto text-gray-400 mb-4"></i>
            <p class="text-gray-500">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¨è</p>
        </div>
    </div>
    
    <!-- ç©ºçŠ¶æ€ -->
    <div x-show="recommendations.length === 0 && !isLoading && !isGenerating" class="text-center py-12">
        <i data-lucide="brain" class="h-16 w-16 mx-auto text-gray-400 mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">è¿˜æ²¡æœ‰æ¨èç»“æœ</h3>
        <p class="text-gray-500 mb-6">ç‚¹å‡»"ç”Ÿæˆæ¨è"å¼€å§‹AIæ™ºèƒ½åˆ†æ</p>
        <button @click="generateRecommendations()" 
                class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
            ğŸš€ å¼€å§‹ç”Ÿæˆæ¨è
        </button>
    </div>
</div>

<script>
function intelligentRecommendationsApp() {
    return {
        recommendations: [],
        filteredRecommendations: [],
        systemHealth: null,
        generationInfo: null,
        isLoading: false,
        isGenerating: false,
        isLoadingHealth: false,
        
        generateSettings: {
            maxStocks: 20,
            maxConcurrent: 5
        },
        
        filters: {
            recommendation: '',
            riskLevel: '',
            marketPosition: '',
            search: ''
        },
        
        init() {
            this.checkSystemHealth();
            this.loadLatestRecommendations();
        },
        
        async checkSystemHealth() {
            this.isLoadingHealth = true;
            try {
                const response = await apiRequest('/api/intelligent/health');
                this.systemHealth = response;
            } catch (error) {
                showToast('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                this.isLoadingHealth = false;
            }
        },
        
        async generateRecommendations() {
            this.isGenerating = true;
            try {
                const response = await apiRequest('/api/intelligent/recommendations/generate', {
                    method: 'POST',
                    body: JSON.stringify({
                        max_stocks: parseInt(this.generateSettings.maxStocks),
                        max_concurrent: parseInt(this.generateSettings.maxConcurrent)
                    })
                });
                
                if (response.success) {
                    this.recommendations = response.data || [];
                    this.generationInfo = response.generation_info;
                    this.filterRecommendations();
                    showToast(`æˆåŠŸç”Ÿæˆ${response.count}æ¡æ¨è`, 'success');
                } else {
                    showToast('æ¨èç”Ÿæˆå¤±è´¥: ' + response.error, 'error');
                }
            } catch (error) {
                showToast('æ¨èç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                this.isGenerating = false;
            }
        },
        
        async loadLatestRecommendations() {
            this.isLoading = true;
            try {
                const response = await apiRequest('/api/intelligent/recommendations/latest?limit=50');
                if (response.success) {
                    this.recommendations = response.data || [];
                    this.filterRecommendations();
                } else {
                    showToast('åŠ è½½æ¨èå¤±è´¥: ' + response.error, 'error');
                }
            } catch (error) {
                showToast('åŠ è½½æ¨èå¤±è´¥: ' + error.message, 'error');
            } finally {
                this.isLoading = false;
            }
        },
        
        filterRecommendations() {
            let filtered = [...this.recommendations];
            
            // æ¨èç±»å‹è¿‡æ»¤
            if (this.filters.recommendation) {
                filtered = filtered.filter(rec => rec.recommendation === this.filters.recommendation);
            }
            
            // é£é™©ç­‰çº§è¿‡æ»¤
            if (this.filters.riskLevel) {
                filtered = filtered.filter(rec => rec.risk_level === this.filters.riskLevel);
            }
            
            // å¸‚åœºåœ°ä½è¿‡æ»¤
            if (this.filters.marketPosition) {
                filtered = filtered.filter(rec => rec.market_position === this.filters.marketPosition);
            }
            
            // æœç´¢è¿‡æ»¤
            if (this.filters.search) {
                const searchTerm = this.filters.search.toLowerCase();
                filtered = filtered.filter(rec => 
                    rec.name.toLowerCase().includes(searchTerm) ||
                    rec.ts_code.toLowerCase().includes(searchTerm)
                );
            }
            
            this.filteredRecommendations = filtered;
        },
        
        getRecommendationBadgeClass(recommendation) {
            switch (recommendation) {
                case 'buy':
                    return 'bg-green-100 text-green-800';
                case 'sell':
                    return 'bg-red-100 text-red-800';
                case 'hold':
                    return 'bg-yellow-100 text-yellow-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        },
        
        getRecommendationText(recommendation) {
            switch (recommendation) {
                case 'buy':
                    return 'ğŸŸ¢ ä¹°å…¥';
                case 'sell':
                    return 'ğŸ”´ å–å‡º';
                case 'hold':
                    return 'ğŸŸ¡ æŒæœ‰';
                default:
                    return 'â“ æœªçŸ¥';
            }
        },
        
        getRiskLevelClass(riskLevel) {
            switch (riskLevel) {
                case 'low':
                    return 'bg-green-100 text-green-800';
                case 'medium':
                    return 'bg-yellow-100 text-yellow-800';
                case 'high':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        },
        
        viewStockDetail(tsCode) {
            window.open(`/analysis?code=${tsCode}`, '_blank');
        },
        
        addToWatchlist(tsCode) {
            // TODO: å®ç°æ·»åŠ åˆ°è‡ªé€‰è‚¡åŠŸèƒ½
            showToast(`å·²æ·»åŠ  ${tsCode} åˆ°è‡ªé€‰è‚¡`, 'success');
        }
    }
}
</script>

<style>
.line-clamp-3 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 3;
}
</style>
{% endblock %}