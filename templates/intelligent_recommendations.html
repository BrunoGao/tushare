{% extends "base.html" %}

{% block title %}智能推荐 - 灵境万象{% endblock %}

{% block content %}
<div x-data="intelligentRecommendationsApp()" x-cloak>
    <!-- 页面头部 -->
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">🤖 智能推荐</h1>
        <p class="mt-1 text-gray-600">基于AI大模型的股票智能分析推荐系统</p>
    </div>
    
    <!-- 系统状态面板 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-2 sm:mb-0">系统状态</h2>
            <button @click="checkSystemHealth()" 
                    :disabled="isLoadingHealth"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                <span x-show="!isLoadingHealth">检查状态</span>
                <span x-show="isLoadingHealth" class="flex items-center">
                    <i data-lucide="loader" class="animate-spin h-4 w-4 mr-2"></i>
                    检查中...
                </span>
            </button>
        </div>
        
        <div x-show="systemHealth" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold" 
                     :class="systemHealth?.overall_status === 'healthy' ? 'text-green-600' : systemHealth?.overall_status === 'error' ? 'text-red-600' : 'text-yellow-600'"
                     x-text="systemHealth?.overall_status === 'healthy' ? '🟢 健康' : systemHealth?.overall_status === 'error' ? '🔴 异常' : '🟡 警告'"></div>
                <div class="text-sm text-gray-500">系统状态</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-blue-600" 
                     x-text="systemHealth?.components?.ollama?.status === 'healthy' ? '🟢 正常' : '🔴 异常'"></div>
                <div class="text-sm text-gray-500">Ollama服务</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-green-600" 
                     x-text="formatNumber(systemHealth?.components?.database?.stock_count || 0)"></div>
                <div class="text-sm text-gray-500">股票数据</div>
            </div>
        </div>
    </div>
    
    <!-- 推荐生成面板 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">推荐设置</label>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">最大股票数</label>
                        <select x-model="generateSettings.maxStocks" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            <option value="10">10只</option>
                            <option value="20">20只</option>
                            <option value="30">30只</option>
                            <option value="50">50只</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">并发数</label>
                        <select x-model="generateSettings.maxConcurrent" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            <option value="3">3</option>
                            <option value="5">5</option>
                            <option value="8">8</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="flex items-end">
                <button @click="generateRecommendations()" 
                        :disabled="isGenerating"
                        class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span x-show="!isGenerating">🚀 生成推荐</span>
                    <span x-show="isGenerating" class="flex items-center justify-center">
                        <i data-lucide="loader" class="animate-spin h-4 w-4 mr-2"></i>
                        生成中...
                    </span>
                </button>
            </div>
            
            <div class="flex items-end">
                <button @click="loadLatestRecommendations()" 
                        :disabled="isLoading"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span x-show="!isLoading">📊 加载最新</span>
                    <span x-show="isLoading" class="flex items-center justify-center">
                        <i data-lucide="loader" class="animate-spin h-4 w-4 mr-2"></i>
                        加载中...
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 生成进度 -->
    <div x-show="generationInfo" class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
        <h3 class="text-lg font-semibold text-blue-900 mb-2">📈 生成统计</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
                <span class="text-blue-700">总数量: </span>
                <span class="font-bold" x-text="generationInfo?.count || 0"></span>
            </div>
            <div>
                <span class="text-green-700">买入: </span>
                <span class="font-bold text-green-600" x-text="generationInfo?.buy_count || 0"></span>
            </div>
            <div>
                <span class="text-yellow-700">持有: </span>
                <span class="font-bold text-yellow-600" x-text="generationInfo?.hold_count || 0"></span>
            </div>
            <div>
                <span class="text-blue-700">平均置信度: </span>
                <span class="font-bold" x-text="(generationInfo?.avg_confidence || 0).toFixed(3)"></span>
            </div>
        </div>
    </div>
    
    <!-- 推荐结果列表 -->
    <div x-show="recommendations.length > 0" class="space-y-4">
        <h2 class="text-xl font-semibold text-gray-900">🎯 推荐结果</h2>
        
        <!-- 过滤器 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="flex flex-wrap gap-3">
                <select x-model="filters.recommendation" @change="filterRecommendations()" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">全部推荐</option>
                    <option value="buy">买入</option>
                    <option value="hold">持有</option>
                    <option value="sell">卖出</option>
                </select>
                
                <select x-model="filters.riskLevel" @change="filterRecommendations()" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">全部风险</option>
                    <option value="low">低风险</option>
                    <option value="medium">中风险</option>
                    <option value="high">高风险</option>
                </select>
                
                <select x-model="filters.marketPosition" @change="filterRecommendations()" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">全部类型</option>
                    <option value="龙头">龙头股</option>
                    <option value="成长">成长股</option>
                    <option value="价值">价值股</option>
                    <option value="小盘">小盘股</option>
                </select>
                
                <input type="text" x-model="filters.search" @input="filterRecommendations()" 
                       placeholder="搜索股票名称或代码..." 
                       class="px-3 py-2 border border-gray-300 rounded-lg flex-1 min-w-48">
            </div>
        </div>
        
        <!-- 推荐卡片 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <template x-for="(rec, index) in filteredRecommendations" :key="rec.ts_code">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <!-- 头部 -->
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900" x-text="rec.name"></h3>
                                <p class="text-sm text-gray-500" x-text="rec.ts_code + ' | ' + rec.sector"></p>
                            </div>
                            <div class="text-right">
                                <div class="px-3 py-1 rounded-full text-sm font-medium"
                                     :class="getRecommendationBadgeClass(rec.recommendation)"
                                     x-text="getRecommendationText(rec.recommendation)"></div>
                                <div class="text-xs text-gray-500 mt-1" x-text="rec.market_position"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 核心指标 -->
                    <div class="p-4">
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-lg font-bold text-purple-600" x-text="rec.confidence.toFixed(3)"></div>
                                <div class="text-xs text-gray-500">置信度</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-blue-600" x-text="rec.technical_score.toFixed(3)"></div>
                                <div class="text-xs text-gray-500">技术分析</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold text-green-600" x-text="rec.ai_score.toFixed(3)"></div>
                                <div class="text-xs text-gray-500">AI分析</div>
                            </div>
                        </div>
                        
                        <!-- 价格信息 -->
                        <div class="grid grid-cols-2 gap-4 mb-4" x-show="rec.target_price || rec.stop_loss">
                            <div x-show="rec.target_price">
                                <div class="text-sm text-gray-500">目标价</div>
                                <div class="text-lg font-semibold text-green-600" x-text="'¥' + rec.target_price.toFixed(2)"></div>
                            </div>
                            <div x-show="rec.stop_loss">
                                <div class="text-sm text-gray-500">止损价</div>
                                <div class="text-lg font-semibold text-red-600" x-text="'¥' + rec.stop_loss.toFixed(2)"></div>
                            </div>
                        </div>
                        
                        <!-- 风险和持有期 -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-500">风险等级:</span>
                                <span class="px-2 py-1 rounded text-xs font-medium"
                                      :class="getRiskLevelClass(rec.risk_level)"
                                      x-text="rec.risk_level"></span>
                            </div>
                            <div class="text-xs text-gray-500" x-text="rec.holding_period"></div>
                        </div>
                        
                        <!-- 关键因素 -->
                        <div class="mb-4" x-show="rec.key_factors && rec.key_factors.length > 0">
                            <div class="text-sm font-medium text-gray-700 mb-2">关键因素</div>
                            <div class="flex flex-wrap gap-1">
                                <template x-for="factor in rec.key_factors.slice(0, 3)" :key="factor">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded" x-text="factor"></span>
                                </template>
                            </div>
                        </div>
                        
                        <!-- 分析推理 -->
                        <div class="mb-4">
                            <div class="text-sm font-medium text-gray-700 mb-2">分析推理</div>
                            <p class="text-sm text-gray-600 line-clamp-3" x-text="rec.reasoning"></p>
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div class="flex space-x-2">
                            <button @click="viewStockDetail(rec.ts_code)" 
                                    class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                                查看详情
                            </button>
                            <button @click="addToWatchlist(rec.ts_code)" 
                                    class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">
                                <i data-lucide="bookmark" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- 无结果提示 -->
        <div x-show="filteredRecommendations.length === 0" class="text-center py-12">
            <i data-lucide="search" class="h-12 w-12 mx-auto text-gray-400 mb-4"></i>
            <p class="text-gray-500">没有找到符合条件的推荐</p>
        </div>
    </div>
    
    <!-- 空状态 -->
    <div x-show="recommendations.length === 0 && !isLoading && !isGenerating" class="text-center py-12">
        <i data-lucide="brain" class="h-16 w-16 mx-auto text-gray-400 mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">还没有推荐结果</h3>
        <p class="text-gray-500 mb-6">点击"生成推荐"开始AI智能分析</p>
        <button @click="generateRecommendations()" 
                class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
            🚀 开始生成推荐
        </button>
    </div>
</div>

<script>
function intelligentRecommendationsApp() {
    return {
        recommendations: [],
        filteredRecommendations: [],
        systemHealth: null,
        generationInfo: null,
        isLoading: false,
        isGenerating: false,
        isLoadingHealth: false,
        
        generateSettings: {
            maxStocks: 20,
            maxConcurrent: 5
        },
        
        filters: {
            recommendation: '',
            riskLevel: '',
            marketPosition: '',
            search: ''
        },
        
        init() {
            this.checkSystemHealth();
            this.loadLatestRecommendations();
        },
        
        async checkSystemHealth() {
            this.isLoadingHealth = true;
            try {
                const response = await apiRequest('/api/intelligent/health');
                this.systemHealth = response;
            } catch (error) {
                showToast('系统状态检查失败: ' + error.message, 'error');
            } finally {
                this.isLoadingHealth = false;
            }
        },
        
        async generateRecommendations() {
            this.isGenerating = true;
            try {
                const response = await apiRequest('/api/intelligent/recommendations/generate', {
                    method: 'POST',
                    body: JSON.stringify({
                        max_stocks: parseInt(this.generateSettings.maxStocks),
                        max_concurrent: parseInt(this.generateSettings.maxConcurrent)
                    })
                });
                
                if (response.success) {
                    this.recommendations = response.data || [];
                    this.generationInfo = response.generation_info;
                    this.filterRecommendations();
                    showToast(`成功生成${response.count}条推荐`, 'success');
                } else {
                    showToast('推荐生成失败: ' + response.error, 'error');
                }
            } catch (error) {
                showToast('推荐生成失败: ' + error.message, 'error');
            } finally {
                this.isGenerating = false;
            }
        },
        
        async loadLatestRecommendations() {
            this.isLoading = true;
            try {
                const response = await apiRequest('/api/intelligent/recommendations/latest?limit=50');
                if (response.success) {
                    this.recommendations = response.data || [];
                    this.filterRecommendations();
                } else {
                    showToast('加载推荐失败: ' + response.error, 'error');
                }
            } catch (error) {
                showToast('加载推荐失败: ' + error.message, 'error');
            } finally {
                this.isLoading = false;
            }
        },
        
        filterRecommendations() {
            let filtered = [...this.recommendations];
            
            // 推荐类型过滤
            if (this.filters.recommendation) {
                filtered = filtered.filter(rec => rec.recommendation === this.filters.recommendation);
            }
            
            // 风险等级过滤
            if (this.filters.riskLevel) {
                filtered = filtered.filter(rec => rec.risk_level === this.filters.riskLevel);
            }
            
            // 市场地位过滤
            if (this.filters.marketPosition) {
                filtered = filtered.filter(rec => rec.market_position === this.filters.marketPosition);
            }
            
            // 搜索过滤
            if (this.filters.search) {
                const searchTerm = this.filters.search.toLowerCase();
                filtered = filtered.filter(rec => 
                    rec.name.toLowerCase().includes(searchTerm) ||
                    rec.ts_code.toLowerCase().includes(searchTerm)
                );
            }
            
            this.filteredRecommendations = filtered;
        },
        
        getRecommendationBadgeClass(recommendation) {
            switch (recommendation) {
                case 'buy':
                    return 'bg-green-100 text-green-800';
                case 'sell':
                    return 'bg-red-100 text-red-800';
                case 'hold':
                    return 'bg-yellow-100 text-yellow-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        },
        
        getRecommendationText(recommendation) {
            switch (recommendation) {
                case 'buy':
                    return '🟢 买入';
                case 'sell':
                    return '🔴 卖出';
                case 'hold':
                    return '🟡 持有';
                default:
                    return '❓ 未知';
            }
        },
        
        getRiskLevelClass(riskLevel) {
            switch (riskLevel) {
                case 'low':
                    return 'bg-green-100 text-green-800';
                case 'medium':
                    return 'bg-yellow-100 text-yellow-800';
                case 'high':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        },
        
        viewStockDetail(tsCode) {
            window.open(`/analysis?code=${tsCode}`, '_blank');
        },
        
        addToWatchlist(tsCode) {
            // TODO: 实现添加到自选股功能
            showToast(`已添加 ${tsCode} 到自选股`, 'success');
        }
    }
}
</script>

<style>
.line-clamp-3 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 3;
}
</style>
{% endblock %}